# ğŸ¤– COPILOT CONTEXT - Apollo Plugins Workspace

**Workspace:** C:\Users\rafae\Local Sites\1212\app\public\wp-content\plugins  
**GitHub:** https://github.com/apollorio/plugins  
**Date:** 2025-11-03  

---

## ğŸ“ WORKSPACE OVERVIEW

Este workspace contÃ©m plugins WordPress para a plataforma **Apollo.rio.br**.

### Estrutura:
```
plugins/
â”œâ”€â”€ apollo-events-manager/    â† PRINCIPAL (desenvolvimento ativo)
â”œâ”€â”€ wp-event-manager/         â† Base (sendo substituÃ­do)
â”œâ”€â”€ wpem-bookmarks/           â† DependÃªncia WPEM
â””â”€â”€ wpem-rest-api/            â† DependÃªncia WPEM
```

---

## ğŸ¯ PLUGIN PRINCIPAL: apollo-events-manager

### VersÃ£o: 2.0.0
Sistema completo de gerenciamento de eventos integrado com Apollo.rio.br.

### Custom Post Types (CPTs)
1. **`event_listing`** - Eventos
2. **`event_dj`** - DJs
3. **`event_local`** - Locais (venues)

### Meta Keys CrÃ­ticos

#### Events (`event_listing`)
```php
// DJs - SERIALIZED ARRAY de string IDs
'_event_dj_ids' => 'a:2:{i:0;s:2:"92";i:1;s:2:"71";}' 
// Unserialize: array("92", "71")

// Local - SINGLE INT
'_event_local_ids' => 95

// Timetable - ARRAY de slots
'_event_timetable' => array(
    array('dj' => 92, 'start' => '22:00', 'end' => '23:00'),
    array('dj' => 71, 'start' => '23:00', 'end' => '00:00')
)

// Banner - URL STRING (NÃƒO Ã© attachment ID!)
'_event_banner' => 'http://localhost:10004/wp-content/uploads/...'

// Datas
'_event_start_date' => '2025-11-03 22:00:00'
'_event_end_date' => '2025-11-04 04:00:00'

// Favoritos
'_favorites_count' => 42
```

#### Locals (`event_local`)
```php
'_local_latitude' => -22.9068
'_local_longitude' => -43.1729
'_local_address' => 'Rua X, 123, Rio de Janeiro'
'_local_name' => 'Nome do Local'
```

---

## ğŸ¨ ASSETS EXTERNOS (CRITICAL!)

### Force Load de assets.apollo.rio.br

```php
// CSS - TODOS OS TEMPLATES
wp_enqueue_style('apollo-uni-css', 'https://assets.apollo.rio.br/uni.css');

// JS - PORTAL (listagem de eventos)
if (!is_single('event_listing')) {
    wp_enqueue_script('apollo-base-js', 'https://assets.apollo.rio.br/base.js');
}

// JS - SINGLE EVENT (pÃ¡gina individual)
if (is_single('event_listing')) {
    wp_enqueue_script('apollo-event-page-js', 'https://assets.apollo.rio.br/event-page.js');
}
```

### Funcionalidades por Arquivo

**base.js** (Portal):
- Typewriter effect no placeholder
- Toggle layout (list/cards)
- Dark mode
- User menu
- Clock
- Filtros (categoria, data, busca)
- "Todos" com fade de idiomas

**event-page.js** (Single):
- Favorite button (rocket animation)
- Avatars explosion
- Event map (Leaflet)
- Route button
- Copy promo code
- Share function
- Sliders (promo/local)

---

## ğŸ“ CODING CONVENTIONS

### PHP (PSR-12)
```php
// Classes
class Apollo_Events_Manager_Plugin {}

// Methods (camelCase)
public function saveCustomEventFields() {}

// Hooks (snake_case)
add_action('apollo_events_ajax', ...);

// Constants
define('APOLLO_DEBUG', true);
```

### JavaScript (ES6+)
```javascript
// Functions (camelCase)
function toggleLayout(el) {}

// Variables (camelCase)
const displayDate = new Date();

// Constants (UPPER_SNAKE_CASE)
const MONTH_NAMES = ['jan', 'fev', ...];
```

### CSS (BEM-like)
```css
.event-listing {}
.event-listing__title {}
.event-listing--featured {}
```

---

## âœ… CORRECT DATA RETRIEVAL

### DJs (ALWAYS unserialize!)
```php
// âœ… CORRECT
$dj_ids = maybe_unserialize(get_post_meta($event_id, '_event_dj_ids', true));
if (is_array($dj_ids)) {
    foreach ($dj_ids as $dj_id) {
        $dj = get_post(intval($dj_id));
        echo $dj->post_title;
    }
}

// âŒ WRONG
$dj_ids = get_post_meta($event_id, '_event_djs', true); // Wrong key!
foreach ($dj_ids as $dj) {} // $dj_ids is string, not array!
```

### Local
```php
// âœ… CORRECT
$local_id = get_post_meta($event_id, '_event_local_ids', true);
$local = get_post(intval($local_id));
echo $local->post_title;

// âŒ WRONG
$local = get_post_meta($event_id, '_event_local', true); // Wrong key!
$local = get_post_meta($event_id, '_event_venue', true); // Removed!
```

### Banner
```php
// âœ… CORRECT (it's already a URL!)
$banner_url = get_post_meta($event_id, '_event_banner', true);
echo '<img src="' . esc_url($banner_url) . '">';

// âŒ WRONG
$banner_id = get_post_meta($event_id, '_event_banner', true);
$banner_url = wp_get_attachment_url($banner_id); // Wrong! It's not an ID!
```

---

## ğŸš« REMOVED/DEPRECATED (DO NOT USE!)

### Removed CPTs
- âŒ `event_organizer` (removed in v2.0.0)

### Removed Meta Keys
- âŒ `_event_organizer` (removed)
- âŒ `_event_venue` (use `_event_local_ids`)
- âŒ `_event_djs` (use `_event_dj_ids`)

### Removed Terminology
- âŒ "Venue" â†’ Use "Local"
- âŒ "Organizer" â†’ Removed completely

### Removed Dependencies
- âŒ WP Event Manager hooks (backward compatibility only)
- âŒ Local JS files (use assets.apollo.rio.br)
- âŒ `portal-filters.js` (replaced by base.js)
- âŒ `uni-filters.js` (replaced by base.js)

---

## ğŸ› DEBUG MODE

### Enable
```php
// wp-config.php
define('APOLLO_DEBUG', true);
```

### Logging
```php
if (APOLLO_DEBUG) {
    error_log('âœ… Success message');
    error_log('âŒ Error message');
    error_log('âš ï¸ Warning message');
}
```

---

## ğŸ§ª TESTING COMMANDS

### WP-CLI
```bash
# List CPTs
wp post-type list | grep event

# Count events
wp post list --post_type=event_listing --format=count

# Flush rewrite
wp rewrite flush

# Check meta
wp post meta list 143

# Check debug log
tail -20 ../wp-content/debug.log | grep -i "error\|fatal"
```

### Database Queries
```bash
# Check DJs format
wp db query "SELECT post_id, meta_value FROM wp_postmeta WHERE meta_key = '_event_dj_ids' LIMIT 5"

# Check Local IDs
wp db query "SELECT post_id, meta_value FROM wp_postmeta WHERE meta_key = '_event_local_ids' LIMIT 5"
```

---

## ğŸ¯ DEVELOPMENT PRIORITIES

1. **Security First**
   - Sanitize: `sanitize_text_field()`, `intval()`, `esc_url_raw()`
   - Validate: `!empty()`, `is_array()`, `post_type_exists()`
   - Nonces: `wp_create_nonce()`, `check_ajax_referer()`

2. **Performance**
   - Use transients for expensive queries
   - Lazy load images
   - Minimize AJAX calls
   - Cache with `wp_cache_get/set`

3. **UX**
   - Visual feedback (loading states)
   - CSS transitions
   - Mobile-first
   - Accessibility (ARIA labels)

4. **Code Quality**
   - DRY (Don't Repeat Yourself)
   - Single Responsibility
   - Meaningful names
   - Comment complex logic

---

## ğŸ“š TEMPLATES STRUCTURE

### Portal (Listagem)
```
templates/
â”œâ”€â”€ event-listings-start.php    # Hero + Filters
â”œâ”€â”€ event-card.php              # Event card component
â”œâ”€â”€ content-event_listing.php   # AJAX filtered card
â””â”€â”€ event-listings-end.php      # Banner + Dark mode toggle
```

### Single Event
```
templates/
â””â”€â”€ single-event-standalone.php # Full event page
```

---

## ğŸ”§ COMMON PATTERNS

### AJAX Handler
```php
public function ajax_handler() {
    // Verify nonce
    check_ajax_referer('apollo_events_nonce', 'nonce');
    
    // Sanitize input
    $event_id = intval($_POST['event_id']);
    
    // Validate
    if (empty($event_id) || get_post_type($event_id) !== 'event_listing') {
        wp_send_json_error(['message' => 'Invalid event']);
    }
    
    // Process
    $result = $this->process_event($event_id);
    
    // Response
    wp_send_json_success(['data' => $result]);
}
```

### Meta Save
```php
public function save_meta($post_id, $post) {
    // Check autosave
    if (defined('DOING_AUTOSAVE') && DOING_AUTOSAVE) return;
    
    // Check permissions
    if (!current_user_can('edit_post', $post_id)) return;
    
    // Save DJs (serialized array)
    if (isset($_POST['event_djs'])) {
        $djs = array_map('strval', array_map('intval', (array) $_POST['event_djs']));
        update_post_meta($post_id, '_event_dj_ids', serialize($djs));
    }
    
    // Save Local (int)
    if (isset($_POST['event_local'])) {
        update_post_meta($post_id, '_event_local_ids', intval($_POST['event_local']));
    }
}
```

---

## ğŸ“ WHEN SUGGESTING CODE

### Always Include:
1. âœ… Correct meta keys
2. âœ… Sanitization/validation
3. âœ… Error handling
4. âœ… Debug logging (if APOLLO_DEBUG)
5. âœ… Comments for complex logic
6. âœ… Type checking (is_array, is_string, etc)

### Never Include:
1. âŒ Wrong meta keys (_event_djs, _event_local, _event_venue)
2. âŒ WP Event Manager dependencies
3. âŒ "Venue" or "Organizer" terminology
4. âŒ Local JS files (use assets.apollo.rio.br)
5. âŒ Treating banner as attachment ID

---

## ğŸ“Š PROJECT STATUS

**Version:** 2.0.0  
**Status:** âœ… Production Ready  
**GitHub:** https://github.com/apollorio/plugins  
**Last Updated:** 2025-11-03  

### Recent Changes:
- âœ… Force load assets from assets.apollo.rio.br
- âœ… Conditional JS loading (base.js vs event-page.js)
- âœ… Removed conflicting local JS files
- âœ… Fixed meta keys (_event_dj_ids, _event_local_ids)
- âœ… Removed "venue" and "organizer" terminology
- âœ… Added migration validator
- âœ… Added backward compatibility layer

---

## ğŸ”— USEFUL LINKS

- **Apollo Assets:** https://assets.apollo.rio.br/
- **Leaflet Docs:** https://leafletjs.com/
- **WordPress Codex:** https://developer.wordpress.org/
- **RemixIcon:** https://remixicon.com/

---

## ğŸ’¡ QUICK REFERENCE

### Get Event Data
```php
$event_id = 143;
$djs = maybe_unserialize(get_post_meta($event_id, '_event_dj_ids', true));
$local_id = get_post_meta($event_id, '_event_local_ids', true);
$banner = get_post_meta($event_id, '_event_banner', true);
$timetable = get_post_meta($event_id, '_event_timetable', true);
```

### Enqueue Assets
```php
wp_enqueue_style('apollo-uni-css', 'https://assets.apollo.rio.br/uni.css');
wp_enqueue_script('apollo-base-js', 'https://assets.apollo.rio.br/base.js');
```

### Debug
```php
if (APOLLO_DEBUG) error_log('ğŸ¯ Message');
```

---

**Remember:** Always check meta key names, unserialize arrays, and use assets.apollo.rio.br!


