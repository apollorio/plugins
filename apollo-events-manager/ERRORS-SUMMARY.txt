â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ”´ APOLLO EVENTS MANAGER - CRITICAL ERRORS SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Analysis Date: November 2, 2025
File: apollo-events-manager.php
Status: 3 CRITICAL ERRORS + 7 WARNINGS

âš ï¸ NO FILES WERE MODIFIED - THIS IS ANALYSIS ONLY

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ”´ ERROR #1: DJs SAVE TO WRONG META KEY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Location: apollo-events-manager.php line 1026
Function: save_custom_event_fields()

CURRENT CODE:
    update_post_meta($post_id, '_event_djs', $djs);

PROBLEM:
    - Saves to: _event_djs
    - Database expects: _event_dj_ids (serialized)
    - Templates look for: _event_dj_ids

IMPACT:
    âŒ Line-up doesn't display
    âŒ DJ names missing from event cards
    âŒ Data is there but in wrong key

CORRECT CODE SHOULD BE:
    $djs = array_map('strval', array_map('intval', (array) $_POST['event_djs']));
    update_post_meta($post_id, '_event_dj_ids', serialize($djs));

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ”´ ERROR #2: LOCAL SAVES TO WRONG META KEY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Location: apollo-events-manager.php line 1031
Function: save_custom_event_fields()

CURRENT CODE:
    update_post_meta($post_id, '_event_local', intval($_POST['event_local']));

PROBLEM:
    - Saves to: _event_local
    - Database expects: _event_local_ids
    - Templates look for: _event_local_ids

IMPACT:
    âŒ Venue name doesn't display
    âŒ Map doesn't work (no coordinates)
    âŒ Location info missing

CORRECT CODE SHOULD BE:
    update_post_meta($post_id, '_event_local_ids', intval($_POST['event_local']));

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ”´ ERROR #3: TIMETABLE NO VALIDATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Location: apollo-events-manager.php line 1036
Function: save_custom_event_fields()

CURRENT CODE:
    update_post_meta($post_id, '_timetable', $_POST['timetable']);

PROBLEMS:
    âŒ No validation if is array
    âŒ No sanitization
    âŒ No sorting by time
    âŒ Can save ANYTHING (string, numeric, etc)

CURRENT DATABASE STATE:
    _timetable => 355453 (numeric - BUG!)

EXPECTED:
    _event_timetable => array(
        array('dj' => 92, 'start' => '22:00', 'end' => '23:00')
    )

IMPACT:
    âŒ Timetable saves as random number
    âŒ Line-up section completely broken
    âŒ DJ times not displayed

CORRECT CODE SHOULD BE:
    if (isset($_POST['timetable']) && is_array($_POST['timetable'])) {
        $clean = array();
        foreach ($_POST['timetable'] as $slot) {
            if (!empty($slot['dj']) && !empty($slot['start'])) {
                $clean[] = array(
                    'dj' => intval($slot['dj']),
                    'start' => sanitize_text_field($slot['start']),
                    'end' => sanitize_text_field($slot['end'] ?? $slot['start'])
                );
            }
        }
        usort($clean, function($a, $b) {
            return strcmp($a['start'], $b['start']);
        });
        update_post_meta($post_id, '_event_timetable', $clean);
    }

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸŸ¡ WARNING #4: DUPLICATE SAVE FUNCTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

TWO FUNCTIONS SAVING THE SAME DATA:

1. save_custom_event_fields() 
   - Hook: event_manager_save_event_listing
   - Saves: _event_djs, _event_local, _timetable (WRONG KEYS)

2. save_metabox_data() (admin-metaboxes.php)
   - Hook: save_post_event_listing (priority 20)
   - Saves: _event_dj_ids, _event_local_ids, _event_timetable (CORRECT KEYS)

RESULT:
    - Both run when saving event
    - Data saved TWICE
    - Wrong keys AND correct keys both exist
    - Database pollution

RECOMMENDATION:
    Remove save_custom_event_fields() entirely OR
    Change it to use correct keys

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸŸ¡ WARNING #5: NO FILE_EXISTS CHECK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Location: apollo-events-manager.php line 105

CODE:
    if (is_admin()) {
        require_once APOLLO_WPEM_PATH . 'includes/admin-metaboxes.php';
    }

PROBLEM:
    - No file_exists() check
    - If file missing: FATAL ERROR
    - Entire admin breaks

RECOMMENDATION:
    Add defensive check:
    
    if (is_admin()) {
        $file = APOLLO_WPEM_PATH . 'includes/admin-metaboxes.php';
        if (file_exists($file)) {
            require_once $file;
        }
    }

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸŸ  WARNING #6: CACHE NOT CLEARED ON SAVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Location: apollo-events-manager.php line 350-371

PROBLEM:
    - Shortcode caches events for 5 minutes
    - Cache not cleared when event is saved
    - User sees old data after editing

IMPACT:
    - Edit event â†’ Save â†’ Reload page
    - Still shows old data for 5 minutes
    - Confusing UX

RECOMMENDATION:
    Add hook to clear cache:
    
    add_action('save_post_event_listing', function($post_id) {
        wp_cache_flush_group('apollo_events');
    });

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸŸ  WARNING #7: AJAX DEFINES UNUSED VARIABLES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Location: apollo-events-manager.php lines 456-469

CODE:
    foreach ($events as $event) {
        $event_id = $event->ID;
        $location = $this->get_event_location($event);  // âŒ Not used
        $month_short = date('M', strtotime($start_date));  // âŒ Not used
        $day = date('j', strtotime($start_date));  // âŒ Not used
        $banner_url = is_array($banner) ? $banner[0] : '';  // âŒ Not used
        
        include APOLLO_WPEM_PATH . 'templates/content-event_listing.php';
    }

PROBLEM:
    - Variables defined but template recalculates them
    - Wasted processing
    - get_the_ID() in template may return wrong ID

RECOMMENDATION:
    Use setup_postdata() properly:
    
    foreach ($events as $event) {
        global $post;
        $post = $event;
        setup_postdata($post);
        include APOLLO_WPEM_PATH . 'templates/content-event_listing.php';
    }
    wp_reset_postdata();

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸŸ¢ INFO #8: GEOCODING WITHOUT RATE LIMIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Location: apollo-events-manager.php line 116-158

ISSUE:
    - Nominatim API: 1 request/second limit
    - No rate limit check in code
    - Bulk operations may fail

IMPACT:
    - Only affects bulk edits
    - Single saves work fine

PRIORITY: Low (edge case)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸŸ¢ INFO #9: SECURITY CHECKS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

AJAX Handlers:
    âœ… check_ajax_referer() - OK
    âœ… current_user_can() - OK
    âœ… sanitize_text_field() - OK

Metabox:
    âœ… wp_nonce_field() / wp_verify_nonce() - OK
    âœ… Permission checks - OK
    âœ… Data sanitization - OK

RESULT: Security is GOOD

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸŸ¢ INFO #10: TEMPLATE STRUCTURE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

VERIFIED:
    âœ… event-listings-start.php - Correct structure
    âœ… content-event_listing.php - Shows DJs and Local
    âœ… event-listings-end.php - Banner + dark mode toggle
    âœ… event-card.php - Full data display
    âœ… single-event-standalone.php - Complete single page

RESULT: Templates are CORRECT (use right meta keys)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“Š SUMMARY TABLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

| # | Issue | Location | Priority | Fixed? |
|---|-------|----------|----------|--------|
| 1 | DJs wrong key | Line 1026 | ğŸ”´ CRITICAL | âŒ NO |
| 2 | Local wrong key | Line 1031 | ğŸ”´ CRITICAL | âŒ NO |
| 3 | Timetable no validation | Line 1036 | ğŸ”´ CRITICAL | âŒ NO |
| 4 | Duplicate save functions | Line 1022 | ğŸŸ¡ HIGH | âŒ NO |
| 5 | No file_exists check | Line 105 | ğŸŸ¡ HIGH | âŒ NO |
| 6 | Cache not cleared | Line 350 | ğŸŸ  MEDIUM | âŒ NO |
| 7 | AJAX unused vars | Line 459 | ğŸŸ  MEDIUM | âŒ NO |
| 8 | Geocode rate limit | Line 139 | ğŸŸ¢ LOW | âŒ NO |
| 9 | Security | Multiple | âœ… OK | âœ… YES |
| 10 | Templates | Multiple | âœ… OK | âœ… YES |

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ¯ IMMEDIATE ACTION REQUIRED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PRIORITY 1 (Fix ASAP):
    [ ] Line 1026: _event_djs â†’ _event_dj_ids
    [ ] Line 1031: _event_local â†’ _event_local_ids
    [ ] Line 1036: Add validation + use _event_timetable

PRIORITY 2 (Fix soon):
    [ ] Remove duplicate save function
    [ ] Add file_exists check
    [ ] Clear cache on save

PRIORITY 3 (Nice to have):
    [ ] Optimize AJAX
    [ ] Add rate limit to geocoding

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ’¾ BEFORE FIXING - BACKUP COMMANDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# 1. Backup database
wp db export backup-before-fix-$(date +%Y%m%d).sql

# 2. Backup plugin files
cp -r apollo-events-manager apollo-events-manager-backup

# 3. Git commit
git add -A
git commit -m "backup: Before meta keys fix"
git push origin main

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“§ SHARE THIS REPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Share with other developers debugging:
- XDEBUG-REPORT.md (detailed technical analysis)
- ERRORS-SUMMARY.txt (this file - quick reference)
- XDEBUG-VERIFICATION-SCRIPT.php (run to verify)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Report generated: November 2, 2025
By: Cursor AI XDebug Analysis
For: Rafael Valle / Apollo Events Team

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•




