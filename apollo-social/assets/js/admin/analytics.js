(function(a){"use strict";var n={init:function(){this.bindEvents(),this.loadAnalyticsStats(),this.setupAutoRefresh()},bindEvents:function(){a("#analytics_driver").on("change",this.toggleDriverConfig),a(document).on("click",".test-connection-btn",this.testConnection),a(document).on("click",".refresh-stats-btn",this.loadAnalyticsStats),a('form[action*="apollo_save_analytics_config"]').on("submit",this.validateForm)},toggleDriverConfig:function(){var t=a(this).val();a(".plausible-config, .matomo-config, .umami-config").hide(),a("."+t+"-config").show()},loadAnalyticsStats:function(){var t=a("#analytics-stats-grid");t.html('<div class="loading">Carregando estat\xEDsticas...</div>'),a.ajax({url:apolloAnalyticsAdmin.ajaxUrl,type:"POST",data:{action:"apollo_analytics_stats",_ajax_nonce:apolloAnalyticsAdmin.nonce},success:function(e){e.success?n.renderStats(e.data):n.showError(t,"Erro ao carregar estat\xEDsticas: "+(e.data||"Erro desconhecido"))},error:function(e,i,o){n.showError(t,"Erro na conex\xE3o: "+o)}})},renderStats:function(t){var e=a("#analytics-stats-grid");if(t.error){this.showError(e,t.error);return}var i="";t.stats&&Object.keys(t.stats).length>0?a.each(t.stats,function(o,s){i+='<div class="stat-card">',i+='<span class="stat-icon">'+s.icon+"</span>",i+='<div class="stat-value">'+s.value+"</div>",i+='<div class="stat-label">'+s.label+"</div>",i+="</div>"}):i='<div class="loading">Nenhum dado dispon\xEDvel. Verifique a configura\xE7\xE3o da API.</div>',e.html(i),this.updateLastRefreshTime()},showError:function(t,e){var i='<div class="notice notice-error"><p>'+e+"</p></div>";t.html(i)},updateLastRefreshTime:function(){var t=new Date,e=t.toLocaleTimeString();a(".last-refresh").remove(),a("#analytics-stats-grid").after('<p class="last-refresh text-muted">\xDAltima atualiza\xE7\xE3o: '+e+"</p>")},setupAutoRefresh:function(){setInterval(function(){n.loadAnalyticsStats()},3e5)},testConnection:function(t){t.preventDefault();var e=a(this),i=e.text();e.text("Testando...").prop("disabled",!0);var o=a("#plausible_domain").val(),s=a("#plausible_api_key").val(),c=a("#plausible_api_base").val();if(!o){alert("Por favor, preencha o dom\xEDnio primeiro."),e.text(i).prop("disabled",!1);return}a.ajax({url:apolloAnalyticsAdmin.ajaxUrl,type:"POST",data:{action:"apollo_test_analytics_connection",_ajax_nonce:apolloAnalyticsAdmin.nonce,domain:o,api_key:s,api_base:c},success:function(r){r.success?alert("Conex\xE3o testada com sucesso! \u2705"):alert("Erro na conex\xE3o: "+(r.data||"Erro desconhecido"))},error:function(r,u,d){alert("Erro na requisi\xE7\xE3o: "+d)},complete:function(){e.text(i).prop("disabled",!1)}})},validateForm:function(t){var e=a("#analytics_enabled").is(":checked");if(e){var i=a("#plausible_domain").val();if(!i)return alert("Por favor, preencha o dom\xEDnio do site para habilitar o analytics."),t.preventDefault(),!1;var o=/^[a-zA-Z0-9][a-zA-Z0-9-]{1,61}[a-zA-Z0-9]\.[a-zA-Z]{2,}$/;if(!o.test(i))return alert("Por favor, insira um dom\xEDnio v\xE1lido (ex: exemplo.com)."),t.preventDefault(),!1}return!0}};window.apolloAnalyticsAdminHelpers={simulateEvent:function(t,e){console.log("Simulating event:",t,e),this.showNotification("Evento simulado: "+t,"success")},showNotification:function(t,e){e=e||"info";var i=a('<div class="notice notice-'+e+' is-dismissible"><p>'+t+"</p></div>");a(".apollo-analytics-admin").prepend(i),setTimeout(function(){i.fadeOut(function(){a(this).remove()})},3e3)},updateEventCount:function(t,e){var i=a('.event-count[data-event="'+t+'"]');i.length&&i.text(e)}};var l={generateSharedDashboardUrl:function(){var t=a("#plausible_domain").val(),e=a("#plausible_api_base").val()||"https://plausible.io";if(t){var i=e+"/share/"+t;a("#plausible_shared_dashboard").val(i),apolloAnalyticsAdminHelpers.showNotification("URL do dashboard gerada. Verifique se o dashboard est\xE1 configurado como p\xFAblico no Plausible.","info")}else alert("Por favor, preencha o dom\xEDnio primeiro.")},copyConfig:function(){var t={domain:a("#plausible_domain").val(),api_base:a("#plausible_api_base").val(),script_url:a("#plausible_script_url").val(),shared_dashboard_url:a("#plausible_shared_dashboard").val()},e=JSON.stringify(t,null,2);if(navigator.clipboard)navigator.clipboard.writeText(e).then(function(){apolloAnalyticsAdminHelpers.showNotification("Configura\xE7\xE3o copiada para a \xE1rea de transfer\xEAncia!","success")});else{var i=a("<textarea>");a("body").append(i),i.val(e).select(),document.execCommand("copy"),i.remove(),apolloAnalyticsAdminHelpers.showNotification("Configura\xE7\xE3o copiada para a \xE1rea de transfer\xEAncia!","success")}}};window.apolloConfigHelper=l,a(document).ready(function(){n.init(),a("#analytics_driver").trigger("change"),a("#plausible_shared_dashboard").length&&a('<button type="button" class="button" onclick="apolloConfigHelper.generateSharedDashboardUrl()">Gerar URL</button>').insertAfter("#plausible_shared_dashboard"),a("#plausible_api_key").length&&a('<button type="button" class="button test-connection-btn">Testar Conex\xE3o</button>').insertAfter("#plausible_api_key")})})(jQuery);

