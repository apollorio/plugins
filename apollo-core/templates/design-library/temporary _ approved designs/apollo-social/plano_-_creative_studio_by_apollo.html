


<!-- <!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Apollo::rio – Studio</title>
<link rel="apple-touch-icon" href="/icons/icon-192.png">
<link rel="mask-icon" href="/icons/icon-192.png" color="#FFF">
<link rel="manifest" href="/manifest.webmanifest">
<meta name="theme-color" content="#f5f9f7">
<style>
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%}
body{background:#0b0d10;color:#0b0d10;font:400 15px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
#frame{position:fixed;inset:0;width:100%;height:100%;border:0;background:#000;opacity:0;visibility:hidden;transition:opacity .8s ease,visibility .8s ease}
#frame.show{opacity:1;visibility:visible}
#cover{position:fixed;inset:0;display:none;background:linear-gradient(135deg,rgba(255,140,0,.18),rgba(255,59,73,.18));backdrop-filter:blur(8px);opacity:1;visibility:visible;transition:opacity .8s ease,visibility .8s ease;z-index:20}
#cover.hide{opacity:0;visibility:hidden}
.center{height:100%;display:grid;place-items:center;padding:24px}
.panel{width:min(92vw,520px);border-radius:20px;padding:20px;background:linear-gradient(135deg,rgba(255,255,255,.15),rgba(255,255,255,.08));border:1px solid rgba(255,140,0,.35);box-shadow:0 10px 40px rgba(0,0,0,.35)}
.logo{font-weight:800;letter-spacing:.4px;margin-bottom:6px;color:#1b1f24}
.title{font:700 20px/1.2 system-ui;margin:6px 0 8px;color:#1b1f24}
.msg{opacity:.85;margin-bottom:12px;color:#1b1f24}
.row{display:flex;gap:10px;flex-wrap:wrap}
.btn{padding:12px 14px;border:0;border-radius:14px;font-weight:800;cursor:pointer;color:#fff;background:linear-gradient(90deg,#FF8C00,#FF6622,#FF3B49,#FF2360);background-size:200% 100%;animation:flow 6s linear infinite}
.steps{margin-top:10px;background:rgba(255,255,255,.6);padding:10px;border-radius:12px;color:#0b0d10}
.hidden{display:none}
@keyframes flow{0%{background-position:0% 50%}100%{background-position:100% 50%}}
@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
</style>
</head>
<body>
<iframe id="frame" title="Apollo Editor" src="" loading="eager" allow="fullscreen"></iframe>

<div id="cover">
  <div class="center">
    <div class="panel">
      <div class="logo">Apollo::rio</div>
      <div class="title" id="title">Instalar na Tela Inicial</div>
      <p class="msg" id="msg">Para melhor experiência, instale como app.</p>
      <div class="row">
        <button id="btnInstall" class="hidden btn">Instalar agora</button>
      </div>
      <div id="ios" class="hidden steps">
        <ol style="margin:0 0 0 18px">
          <li>Abrir Compartilhar no Safari</li>
          <li>Adicionar à Tela de Início</li>
          <li>Confirmar Adicionar</li>
        </ol>
      </div>
    </div>
  </div>
</div>

<script type="module" src="https://cdn.jsdelivr.net/npm/@khmyznikov/pwa-install@0.5.8/dist/pwa-install.es.js"></script>
<pwa-install id="pwa" manual-apple name="Apollo::rio" icon="/icons/icon-192.png" description="Instale o Apollo::rio para experiência completa."></pwa-install>
<script>
if('serviceWorker'in navigator){navigator.serviceWorker.register('/sw.js').catch(()=>{});}

const frame=document.getElementById('frame');
const cover=document.getElementById('cover');
const btnInstall=document.getElementById('btnInstall');
const iosBox=document.getElementById('ios');
const pwa=document.getElementById('pwa');

const ua=navigator.userAgent||'';
const isIOS=/iPhone|iPad|iPod/i.test(ua);
const isAndroid=/Android/i.test(ua);
const isMobile=(navigator.userAgentData&&navigator.userAgentData.mobile===true)||isIOS||isAndroid;
const isStandalone=matchMedia('(display-mode: standalone)').matches||navigator.standalone===true;

const APP_URL='c2.ht';

function showFrame(){if(!frame.src)frame.src=APP_URL;frame.classList.add('show');}
function hideCover(){cover.classList.add('hide');setTimeout(()=>{cover.style.display='none';},800);}
function desktopFlow(){showFrame();hideCover();}
function gateFlow(){cover.style.display='block';if(isAndroid)btnInstall.classList.remove('hidden');if(isIOS)iosBox.classList.remove('hidden');try{pwa.openPrompt();}catch(e){}}
function pwaFlow(){showFrame();hideCover();}

window.addEventListener('load',()=>{
  if(isMobile&&isStandalone){pwaFlow();return;}
  if(!isMobile){desktopFlow();return;}
  gateFlow();
});

btnInstall.addEventListener('click',()=>{try{pwa.openPrompt();}catch(e){}});
matchMedia('(display-mode: standalone)').addEventListener?.('change',ev=>{if(ev.matches)pwaFlow();});
</script>
</body>
</html> -->

<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0,user-scalable=no,viewport-fit=cover" />
<meta name="mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Plano.px"><meta name="theme-color" content="#f5f9f7"><link rel="apple-touch-icon" href="https://assets.apollo.rio.br/plano.webp"><link rel="mask-icon" href="/assets.apollo.rio.br/plano.webp" color="#f5f9f7">
<link rel="manifest" href="manifest.json"><title>Apollo Creative Studio</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css"/>
<script src="https://cdn.jsdelivr.net/npm/fabric@5.3.0/dist/fabric.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<style>

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
body { user-select: none; }
body.text-editing-mode, body.text-editing-mode * { user-select: text !important; -webkit-user-select: text !important; }
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100dvh; /* Dynamic viewport height for mobile Safari */
  min-height: -webkit-fill-available;
  font: 400 15px/1.25 system-ui, sans-serif;
  color: rgba(19,21,23,.65);
  overflow: hidden;
  -ms-overflow-style: none;
  scrollbar-width: none;
  position: relative;
  background:#f5f9f7;
  /* iOS Safe Area support */
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
  padding-left: env(safe-area-inset-left);
  padding-right: env(safe-area-inset-right);
}

i { font-size:21px; color:#121212;align-items: center;vertical-align: middle; }

/* --- topo menu --- */
.menu-h-apollo-topo {
  position: fixed; top: 0; left: 0;
  width: 100%; height: 60px;
  z-index: 998;
}

/* --- blur bg --- */
.menu-h-apollo-blur {
  position: absolute; inset: 0;
  backdrop-filter: blur(2px);
  -webkit-backdrop-filter: blur(2px);
  background: linear-gradient(to bottom, rgba(253,253,253,.35) 0%, transparent 100%);
  -webkit-mask: linear-gradient(to bottom, #000 0%, transparent 100%);
  mask: linear-gradient(to bottom, #000 0%, transparent 100%);
  pointer-events: none;
}

/* --- logo --- */
#logo,.logo {
  position: absolute; top: 15px; left: 15px;
  height: 23px; width: auto;
  opacity: .8; cursor: grab;
  z-index: 1;
}

/* --- container menu --- */
.menu-h-apollo {
  position: absolute; top: 18px; right: 17px;
  display: flex; align-items: center; gap: 8px;
  height: 22px; z-index: 1;
}

/* --- ícones --- */
.menu-h-apollo i {
  font-size: 1.45rem;
  color: rgba(19,21,23,.65);
  cursor: pointer;
  transition: color .2s;
}
.menu-h-apollo i:hover { color: rgba(19,21,23,.9); }

/* --- color pickers --- */
.color-picker-container,#elem-color-input {
  position: relative;
  height: 26px; width:26px;
  border: 1px solid rgba(0,0,0,.1);
  border-radius: 50%;
  display: inline-block;background:#eaddd0;
}
.color-picker-input {
  position: absolute; inset: 0;
  width: 100%; height: 100%;
  opacity: 0; cursor: pointer;
}

#canvas-wrapper{ position:fixed; top:50%; left:53%; transform:translate(-50%,-50%); width:90vw; max-width:320px; aspect-ratio:9/16; border-radius:35px; box-shadow:0 20px 150px rgba(33,33,33,.07); overflow:hidden; z-index:10; transition: all .35s ease; }
#canvas-wrapper.ratio-square{ aspect-ratio:1/1; max-width:400px; }
canvas { border-radius:20px; }
#download-btn {  margin-right:2px; cursor: pointer; z-index: 10000; }
.side-menu{ position:fixed; top:50%; transform:translateY(-50%); left:20px; width:48px; background:rgba(255,255,255,.8); border-radius:25px;corner-shape:squircle; padding:4px 0; display:flex; flex-direction:column; align-items:center; gap:8px; box-shadow:0 4px 20px rgba(0,0,0,.07); z-index:200;backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); }
.side-btn{ width:44px; height:44px; display:flex; align-items:center; justify-content:center; border-radius:50%; border:none; background:transparent; cursor:pointer; color:#333; transition:.2s; }
.side-btn:hover{ background:rgba(0,0,0,.08); }
.side-btn:active{ transform:scale(.92); background:rgba(0,0,0,.15); }
.slide-panel{ position:fixed; top:50%; transform:translateY(-50%); left:73px; width:0; opacity:0; background:white; border-radius:15px;corner-shape:squircle; box-shadow:0 4px 20px rgba(0,0,0,.15); overflow:hidden; transition: all .25s cubic-bezier(.4,0,.2,1); z-index:190; }
.slide-panel.active{ width:200px; opacity:1; }
.panel-content{ padding:12px; display:flex; flex-direction:column; gap:10px; }
.panel-btn{ padding:12px; background:#f5f5f5; border:none; border-radius:10px;corner-shape:squircle; cursor:pointer; display:flex; align-items:center; gap:10px; transition:.2s; font-size:14px; color:#333; }
.panel-btn:hover{ background:#e9e9e9cc; backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);}
.element-controls{ position:fixed; bottom: calc(20px + env(safe-area-inset-bottom, 0px)); transform:none; left:20px; background:rgba(255,255,255,.85); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-radius:25px; padding:8px 12px; display:flex; align-items:center; gap:8px; box-shadow: 0 4px 20px rgba(0,0,0,.12); z-index:180; transition: all .25s ease; opacity:0; pointer-events:none; max-width: calc(100vw - 40px); overflow:hidden; }
.element-controls.active{ opacity:1; pointer-events:auto; }
.control-group{ display:flex; gap:8px; }
.font-control, .box-control{ display:none; }
.element-controls.text-active .font-control{ display:flex; }
.element-controls.text-active .box-control{ display:none !important; } /* Hide border radius for TEXT */
.element-controls.box-active .box-control{ display:flex; }
.element-controls.box-active .font-control{ display:none !important; } /* Hide font controls for IMAGE/SHAPE */
.element-controls.image-active .box-control{ display:flex; }
.element-controls.image-active .font-control{ display:none !important; } /* Hide font controls for IMAGE */
.color-picker-circle{ width:36px; height:36px; min-width:36px; min-height:36px; aspect-ratio:1/1; border-radius:50%; border:2px solid rgba(255,255,255,.6); overflow:hidden; position:relative; cursor:pointer; flex-shrink:0; }
.color-picker-circle input{ position:absolute; inset:0; opacity:0; cursor:pointer; }
.control-popup{ position:fixed; background:rgba(255,255,255,0);  z-index:300; display:none; left:73px; backdrop-filter: blur(13px); -webkit-backdrop-filter: blur(13px); }
.control-popup.active{ display:block;transform:translateY(-44px) translatex(-159px)!important;}
.control-popup.active label{font-size:12px;margin:0 0 -5px 0;padding:0 3px;}
.control-popup input[type="range"]{ width:140px; }
.modal{ position:fixed; inset:0; background:rgba(0,0,0,.65); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); display:flex; align-items:center; justify-content:center; z-index:2000; padding:20px; }
.modal.hidden{ display:none; }
.modal-content{ background:#fff; border-radius:18px;; padding:18px; width:88vw; max-width:520px; max-height:80vh; overflow:auto; position:relative; }
.modal-close{ position:absolute; top:10px; right:10px; width:30px; height:30px; border:none; border-radius:50%; background:transparent; font-size:22px; font-weight:800; cursor:pointer; }
.modal-close:hover{ background:rgba(0,0,0,.1); }
.item-grid{ display:grid; grid-template-columns: repeat(auto-fill,minmax(110px,1fr)); gap:12px; margin-top:14px; }
.grid-item{ aspect-ratio:9/16; border-radius:10px;corner-shape:squircle; cursor:default;color:#333; opacity:0.5;transition: transform .2s; position:relative; overflow:hidden; border:1px solid #eee; }
.grid-item:hover{ transform: scale(1.02); }
.template-preview{ font-size:8px; color:#333333CC; text-align:center; display:flex; align-items:center; justify-content:center; position:relative; }
.preview-overlay{ position:absolute; inset:0; background:rgba(255,255,255,.82); display:flex; align-items:center; justify-content:center; font-weight:700; font-size:13px; }
@media (max-width:989px){
    .side-menu{ position:fixed; top:50%; left:3.8px!important; width:39px!important; padding:8px 0; gap:8px; } 
    .control-group{ display:flex; gap:2px; } 
    i { font-size:17px; }
    .side-btn{ font-size:15px; width:36px; height:36px; touch-action: manipulation; } 
    .control-popup.active{ display:block;transform:translateY(-44px) translatex(-100px)!important;} 
    .element-controls{gap:4px!important;left:5px!important;bottom: calc(12px + env(safe-area-inset-bottom, 0px))!important; right:5px!important; justify-content:center; flex-wrap:nowrap; padding:6px 10px!important; overflow:hidden!important;} 
    .color-picker-circle{ width:32px!important; height:32px!important; min-width:32px!important; min-height:32px!important; aspect-ratio:1/1!important; flex-shrink:0!important; }
    .slide-panel{ left:53px!important; }
    #layer-up-btn{position:absolute; transform:translateY(-50%); left:48px;top:22%;}
    #layer-down-btn{position:absolute; transform:translateY(-50%); left:48px;top:80%;}
    #elem-font-btn{margin-left:33px!important;}
    #logo,.logo {position: absolute; top: calc(3px + env(safe-area-inset-top, 0px))!important; left: 19px;}
    .menu-h-apollo {position: absolute; top: calc(3px + env(safe-area-inset-top, 0px))!important; right: 17px;}
    #canvas-wrapper{ top:calc(50% + env(safe-area-inset-top, 0px)/2 - env(safe-area-inset-bottom, 0px)/2); }
    .modal-content{ max-height: calc(80vh - env(safe-area-inset-bottom, 0px)); }
}
.ri-vngrete-v {
  display: inline-block;
  width: 1em;
  height: 1em;
  background-color: currentColor;
  -webkit-mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1920 1920"><path d="M960 1642.264c138.868 0 253.585 102.642 271.698 241.51C1147.17 1907.924 1050.566 1920 960 1920c-90.566 0-181.132-12.075-271.698-36.226 12.075-138.868 132.83-241.51 271.698-241.51Zm476.981-205.283c102.642-96.604 259.623-108.68 362.264-18.113-90.566 156.981-223.396 289.811-386.415 386.415-84.528-114.717-72.453-271.698 24.151-368.302Zm-1328.302-24.15c114.717-84.53 271.698-72.454 368.302 24.15 96.604 102.642 108.68 259.623 18.113 362.264-156.98-90.566-289.811-223.396-386.415-386.415ZM960 1394.716c42.264 0 78.49 36.226 84.528 84.528 0 48.302-36.226 90.566-84.528 90.566h-6.038c-48.302 0-84.528-42.264-84.528-90.566s42.264-84.528 90.566-84.528Zm295.85-126.792c36.225-30.19 84.527-30.19 114.716 0 36.226 30.188 36.226 84.528 6.038 120.754 0 5.726-5.43 6.022-5.991 6.037l-.047.001c-36.226 30.189-90.566 30.189-120.755-6.038-30.188-36.226-30.188-90.566 6.038-120.754Zm-724.53-6.038c30.19-30.189 90.567-30.189 120.755 0 36.227 30.188 36.227 84.528 0 120.755-30.188 36.226-84.528 30.188-120.754 0-36.227-30.19-36.227-84.529 0-120.755ZM36.227 688.302c138.868 12.075 241.51 132.83 241.51 271.698 0 138.868-108.68 259.623-241.51 271.698C12.076 1141.132 0 1050.566 0 960c0-90.566 12.075-187.17 36.226-271.698Zm1847.548 0C1907.924 772.83 1920 869.434 1920 960c0 90.566-12.075 181.132-36.226 271.698-132.83-12.075-241.51-132.83-241.51-271.698 0-138.868 102.642-259.623 241.51-271.698Zm-1443.02 187.17c46.672 0 84.529 37.856 84.529 84.528 0 46.672-37.857 84.528-84.528 84.528-46.672 0-84.529-37.856-84.529-84.528 0-46.672 37.857-84.528 84.529-84.528Zm1038.491-6.038c48.302 0 84.529 42.264 84.529 84.528 0 48.302-36.227 84.529-84.529 84.529s-84.528-36.227-84.528-84.529 36.226-84.528 84.528-84.528Zm-211.32-338.113c30.188-30.189 84.528-30.189 114.717 0 36.226 30.188 36.226 84.528 6.037 120.754-36.226 30.19-84.528 30.19-114.717 0-36.226-30.188-36.226-84.528-6.037-120.754Zm-736.604-6.038c30.188-30.189 84.528-30.189 120.754 0 30.19 30.189 36.227 84.528 0 120.755-30.188 36.226-84.528 30.188-120.754 0-36.227-30.189-36.227-84.529 0-120.755Zm887.547-410.566c156.981 90.566 289.811 223.396 386.415 386.415-114.717 84.528-271.698 72.453-368.302-24.15-96.604-96.605-108.68-253.586-18.113-362.265Zm-917.736 0c84.528 108.68 78.49 265.66-24.15 362.264-96.605 96.604-253.586 108.68-362.265 24.151 90.566-163.019 223.396-295.849 386.415-386.415ZM960 356.227c42.264 0 84.528 36.226 84.528 78.49 0 48.302-36.226 90.566-84.528 90.566-48.302 0-84.528-36.226-84.528-84.528 0-48.302 36.226-84.529 84.528-84.529ZM960 0c96.604 0 187.17 12.075 277.736 36.226-18.113 132.83-138.868 241.51-277.736 241.51S700.377 175.094 682.264 36.226C772.83 12.076 863.396 0 960 0Z" fill-rule="evenodd"/></svg>') no-repeat center / contain;
  mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1920 1920"><path d="M960 1642.264c138.868 0 253.585 102.642 271.698 241.51C1147.17 1907.924 1050.566 1920 960 1920c-90.566 0-181.132-12.075-271.698-36.226 12.075-138.868 132.83-241.51 271.698-241.51Zm476.981-205.283c102.642-96.604 259.623-108.68 362.264-18.113-90.566 156.981-223.396 289.811-386.415 386.415-84.528-114.717-72.453-271.698 24.151-368.302Zm-1328.302-24.15c114.717-84.53 271.698-72.454 368.302 24.15 96.604 102.642 108.68 259.623 18.113 362.264-156.98-90.566-289.811-223.396-386.415-386.415ZM960 1394.716c42.264 0 78.49 36.226 84.528 84.528 0 48.302-36.226 90.566-84.528 90.566h-6.038c-48.302 0-84.528-42.264-84.528-90.566s42.264-84.528 90.566-84.528Zm295.85-126.792c36.225-30.19 84.527-30.19 114.716 0 36.226 30.188 36.226 84.528 6.038 120.754 0 5.726-5.43 6.022-5.991 6.037l-.047.001c-36.226 30.189-90.566 30.189-120.755-6.038-30.188-36.226-30.188-90.566 6.038-120.754Zm-724.53-6.038c30.19-30.189 90.567-30.189 120.755 0 36.227 30.188 36.227 84.528 0 120.755-30.188 36.226-84.528 30.188-120.754 0-36.227-30.19-36.227-84.529 0-120.755ZM36.227 688.302c138.868 12.075 241.51 132.83 241.51 271.698 0 138.868-108.68 259.623-241.51 271.698C12.076 1141.132 0 1050.566 0 960c0-90.566 12.075-187.17 36.226-271.698Zm1847.548 0C1907.924 772.83 1920 869.434 1920 960c0 90.566-12.075 181.132-36.226 271.698-132.83-12.075-241.51-132.83-241.51-271.698 0-138.868 102.642-259.623 241.51-271.698Zm-1443.02 187.17c46.672 0 84.529 37.856 84.529 84.528 0 46.672-37.857 84.528-84.528 84.528-46.672 0-84.529-37.856-84.529-84.528 0-46.672 37.857-84.528 84.529-84.528Zm1038.491-6.038c48.302 0 84.529 42.264 84.529 84.528 0 48.302-36.227 84.529-84.529 84.529s-84.528-36.227-84.528-84.529 36.226-84.528 84.528-84.528Zm-211.32-338.113c30.188-30.189 84.528-30.189 114.717 0 36.226 30.188 36.226 84.528 6.037 120.754-36.226 30.19-84.528 30.19-114.717 0-36.226-30.188-36.226-84.528-6.037-120.754Zm-736.604-6.038c30.188-30.189 84.528-30.189 120.754 0 30.19 30.189 36.227 84.528 0 120.755-30.188 36.226-84.528 30.188-120.754 0-36.227-30.189-36.227-84.529 0-120.755Zm887.547-410.566c156.981 90.566 289.811 223.396 386.415 386.415-114.717 84.528-271.698 72.453-368.302-24.15-96.604-96.605-108.68-253.586-18.113-362.265Zm-917.736 0c84.528 108.68 78.49 265.66-24.15 362.264-96.605 96.604-253.586 108.68-362.265 24.151 90.566-163.019 223.396-295.849 386.415-386.415ZM960 356.227c42.264 0 84.528 36.226 84.528 78.49 0 48.302-36.226 90.566-84.528 90.566-48.302 0-84.528-36.226-84.528-84.528 0-48.302 36.226-84.529 84.528-84.529ZM960 0c96.604 0 187.17 12.075 277.736 36.226-18.113 132.83-138.868 241.51-277.736 241.51S700.377 175.094 682.264 36.226C772.83 12.076 863.396 0 960 0Z" fill-rule="evenodd"/></svg>') no-repeat center / contain;
}
.ri-folder-v {
  display: inline-block;
  width: 1em;
  height: 1em;
  background-color: currentColor;
  -webkit-mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1920 1920"><path d="M225.882 564.765V451.824h764.386L764.386 113H0v1524.706c0 93.402 76.01 169.412 169.412 169.412h1581.176c93.403 0 169.412-76.01 169.412-169.412V564.765H225.882Z" fill-rule="evenodd"/></svg>') no-repeat center / contain;
  mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1920 1920"><path d="M225.882 564.765V451.824h764.386L764.386 113H0v1524.706c0 93.402 76.01 169.412 169.412 169.412h1581.176c93.403 0 169.412-76.01 169.412-169.412V564.765H225.882Z" fill-rule="evenodd"/></svg>') no-repeat center / contain;
}

.ri-XXX {
  display: inline-block;
  width: 1em;
  height: 1em;
  background-color: currentColor;
  -webkit-mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M128,256A128,128,0,1,0,256,384,128,128,0,0,0,128,256Zm379-54.86L400.07,18.29a37.26,37.26,0,0,0-64.14,0L229,201.14C214.76,225.52,232.58,256,261.09,256H474.91C503.42,256,521.24,225.52,507,201.14ZM480,288H320a32,32,0,0,0-32,32V480a32,32,0,0,0,32,32H480a32,32,0,0,0,32-32V320A32,32,0,0,0,480,288Z"/></svg>') no-repeat center / contain;
  mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M128,256A128,128,0,1,0,256,384,128,128,0,0,0,128,256Zm379-54.86L400.07,18.29a37.26,37.26,0,0,0-64.14,0L229,201.14C214.76,225.52,232.58,256,261.09,256H474.91C503.42,256,521.24,225.52,507,201.14ZM480,288H320a32,32,0,0,0-32,32V480a32,32,0,0,0,32,32H480a32,32,0,0,0,32-32V320A32,32,0,0,0,480,288Z"/></svg>') no-repeat center / contain;
}
.ri-font-weight {
  display: inline-block;
  width: 1em;
  height: 1em;
  background-color: currentColor;
  -webkit-mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" fill="currentColor"><rect x="8" y="12" width="48" height="4" rx="2"/><rect x="8" y="24" width="48" height="6" rx="3"/><rect x="8" y="36" width="48" height="8" rx="4"/><rect x="8" y="50" width="48" height="10" rx="5"/></svg>') no-repeat center / contain;
  mask: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" fill="currentColor"><rect x="8" y="12" width="48" height="4" rx="2"/><rect x="8" y="24" width="48" height="6" rx="3"/><rect x="8" y="36" width="48" height="8" rx="4"/><rect x="8" y="50" width="48" height="10" rx="5"/></svg>') no-repeat center / contain;
}
/* Undo/Redo buttons */
.undo-redo-group { display:flex; gap:2px; align-items:center; }
.undo-redo-btn { width:28px; height:28px; border:none; background:rgba(0,0,0,.05); border-radius:8px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:.2s; }
.undo-redo-btn:hover { background:rgba(0,0,0,.12); }
.undo-redo-btn:active { transform:scale(.92); }
.undo-redo-btn:disabled { opacity:.3; cursor:not-allowed; }
.undo-redo-btn i { font-size:16px; color:#333; }

/* BEACH TOGGLE - Transparent BG */
.beach-toggle {
  position:relative; display:flex; justify-content:space-between;
  width:26px; height:26px; border-radius:1.125rem; cursor:pointer; overflow:hidden; transition:all 2s ease;
  background-color:#fff;
  background-image:linear-gradient(45deg,#d4d4d8 25%,transparent 25%,transparent 75%,#d4d4d8 75%,#d4d4d8),linear-gradient(45deg,#d4d4d8 25%,transparent 25%,transparent 75%,#d4d4d8 75%,#d4d4d8);
  background-size:8px 8px; background-position:0 0,4px 4px;
}

.beach-toggle::after {
            content: "";
            position: absolute;
            inset: 0;
            border-radius: 9999px;
            box-shadow: 0 0.1rem 5px rgba(0,0,0,.15);
            outline: 2px solid #fff; /* White inner border */
            z-index: 3;
            pointer-events: none;
            transition: all 0.3s ease-in-out;
        }

        /* WATER ELEMENT (Main Layer) */
        .beach-toggle__water {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(85deg, #78d6c6, #419197, #12486b);
            background-size: 200% 100%;
            z-index: 1;
            opacity: 1;
            /* Set transition time to 0.5s for the slide effect */
            transition: transform 0.5s ease-out, opacity 0.5s ease-out; 
            clip-path: inset(0 0 0 0); /* Ensure full coverage */
            animation: beachWaves 4.5s infinite ease-in-out;
        }

        /* Water pseudo-elements (Waves/Highlights) */
        .beach-toggle__water::before, .beach-toggle__water::after {
            content: "";
            position: absolute;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(120, 214, 198, .3);
            opacity: 0.6;
            /* Apply the same base transition time */
            transition: transform 0.5s ease-out, opacity 0.5s ease-out; 
            /* Ensure initial state is not hidden */
            transform: translateX(0);
        }

        .beach-toggle__water::before {
            animation: beachWaves2 5s infinite ease-in-out;
        }
        .beach-toggle__water::after {
            animation: beachWaves3 4s infinite ease-in-out;
        }

        /* Keyframes remain for wave movement */
        @keyframes beachWaves {
            0%, 100% { background-position: 0% 0 }
            50% { background-position: 100% 0 }
        }
        @keyframes beachWaves2 {
            0%, 100% {
                left: 0;
                filter: brightness(1.5) saturate(1.5);
                clip-path: path("M 45 0 C 27 0 36 18 18 36 C 72 36 72 0 72 0");
            }
            50% {
                left: 20%;
                filter: brightness(.6) saturate(1) contrast(.8);
                clip-path: path("M 22.5 0 C 27 0 36 18 27 36 C 49.5 36 54 0 72 0");
            }
        }
        @keyframes beachWaves3 {
            0%, 100% {
                left: 20%;
                clip-path: path("M 54 0 C 45 0 54 18 40.5 36 C 27 36 72 4.5 0 0");
            }
            50% {
                left: 0;
                filter: brightness(1.5) saturate(1.5);
                clip-path: path("M 54 0 C 67.5 0 72 18 40.5 36 C 4.5 36 49.5 4.5 0 0");
            }
        }

        /* ACTIVE STATE - Staggered slide-out */
        .beach-toggle--active .beach-toggle__water {
            transform: translateX(110%); /* Slide away */
            opacity: 0; /* Fade out */
            transition-delay: 0s; /* Layer 1 starts immediately */
        }
        
        .beach-toggle--active .beach-toggle__water::before {
            transform: translateX(110%); /* Slide away */
            opacity: 0; /* Fade out */
            transition-delay: 0.5s; /* Layer 2 starts after 0.5s delay */
        }
        
        .beach-toggle--active .beach-toggle__water::after {
            transform: translateX(110%); /* Slide away */
            opacity: 0; /* Fade out */
            transition-delay: 1.0s; /* Layer 3 starts after 1.0s delay (0.5s + 0.5s) */
        }

/* Text type selector */
.text-type-selector { display:flex; flex-wrap:wrap; gap:4px; padding:8px; background:rgba(255,255,255,.95); border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,.1); }
.text-type-btn { padding:6px 10px; border:1px solid #ddd; border-radius:8px; background:#f5f5f5; font-size:12px; cursor:pointer; transition:.2s; }
.text-type-btn:hover { background:#e0e0e0; }
.text-type-btn.active { background:#ff8c00; color:#fff; border-color:#ff8c00; }
</style>
</head>
<body><img src="https://vertente.apollo.rio.br/i.png" class="logo" id="bal-dropper" alt="Apollo" />
<header class="menu-h-apollo ">
<div class="top-menu">
<div class="flex items-center gap-2">
<div class="undo-redo-group">
<button class="undo-redo-btn" id="undo-btn" title="Desfazer (Ctrl+Z)" disabled><i class="ri-arrow-go-back-line"></i></button>
<button class="undo-redo-btn" id="redo-btn" title="Refazer (Ctrl+Y)" disabled><i class="ri-arrow-go-forward-line"></i></button>
</div>

<button class="" id="download-btn" title="Download">
<i class="ri-save-3-fill"></i>
</button>

<div class="beach-toggle" id="transparent-bg-toggle" title="Fundo Transparente (clique para alternar)">
<div class="beach-toggle__water"><div class="beach-toggle__foam"></div></div>
</div>

<div class="color-picker-container" title="Cor de Fundo">
<input type="color" class="color-picker-input" id="bg-color" value="#f9a748" />
</div>

</div>
</div></header>
<div id="canvas-wrapper">
<canvas id="apollo-canvas"></canvas>
</div>
<div class="side-menu">
<button class="side-btn" id="build-btn" title="Adicionar"><i class="ri-XXX"></i></button>
<button class="side-btn" id="templates-btn" title="Modelos"><i class="ri-stack-fill"></i></button>
<button class="side-btn" id="ratio-btn" title="Proporção"><i class="ri-aspect-ratio-line"></i></button>
<button class="side-btn" id="gradient-btn" title="Gradientes"><i class="ri-pantone-fill"></i></button>
<button class="side-btn" id="delete-btn" title="Deletar"><i class="ri-delete-bin-line"></i></button>
</div>
<div class="slide-panel" id="build-panel">
<div class="panel-content">
<button class="panel-btn" id="add-text-btn"><i class="ri-text"></i><span>Texto</span></button>
<button class="panel-btn" id="add-image-btn"><i class="ri-image-line"></i><span>Imagem</span></button>
<button class="panel-btn" id="add-box-btn"><i class="ri-shape-line"></i><span>Caixa</span></button>
</div>
</div>
<div class="element-controls" id="element-controls">
<div class="color-picker-circle" id="elem-color-circle" title="Cor do Elemento">
<input type="color" id="elem-color-input" value="#ffffff">
</div>
<div class="control-group font-control">
<button class="side-btn" id="elem-font-btn" title="Fonte"><i class="ri-font-size"></i></button>
<button class="side-btn" id="elem-texttype-btn" title="Tipo de Texto (H1-P)"><i class="ri-font-size-2"></i></button>
<button class="side-btn" id="elem-fontsize-btn" title="Tamanho"><i class="ri-line-height"></i></button>
<button class="side-btn" id="elem-fontweight-btn" title="Peso da Fonte"><i class="ri-font-weight"></i></button>
<button class="side-btn" id="align-btn" title="Alinhamento"><i class="ri-align-center"></i></button>
</div>
<div class="control-group box-control">
<button class="side-btn" id="elem-border-btn" title="Borda"><i class="ri-rounded-corner"></i></button>
</div>
<div class="control-group">
<button class="side-btn" id="layer-up-btn" title="Acima"><i class="ri-arrow-up-s-line"></i></button>
<button class="side-btn" id="layer-down-btn" title="Atrás"><i class="ri-arrow-down-s-line"></i></button>
</div>
<div class="control-group">
<button class="side-btn" id="elem-opacity-btn" title="Transparência"><i class="ri-ink-bottle-line"></i></button>
<button class="side-btn" id="elem-blend-btn" title="Mix Cores"><i class="ri-dashboard-2-fill"></i></button>
<button class="side-btn" id="elem-blur-btn" title="Desfoque"><i class="ri-focus-2-line"></i></button>
</div>
</div>
<div class="control-popup" id="border-popup">
<label>Borda <span id="border-value">0</span>x</label><br/>
<input type="range" id="border-slider" min="0" max="200" value="0">
</div>
<div class="control-popup" id="opacity-popup">
<label>Transparência <span id="opacity-value">100</span>%</label><br/>
<input type="range" id="opacity-slider" min="0" max="100" value="100">
</div>
<div class="control-popup" id="blur-popup">
<label>Desfoque <span id="blur-value">0</span>x</label><br/>
<input type="range" id="blur-slider" min="0" max="30" value="0">
</div>
<div class="control-popup" id="fontsize-popup">
<label>Tamanho <span id="fontsize-value">24</span>x</label><br/>
<input type="range" id="fontsize-slider" min="10" max="150" value="24">
</div>
<div class="control-popup" id="blend-popup">
<select id="blend-select" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg h-fit w-fit p-2.5">
<option value="normal">Simples</option>
<option value="multiply">Múltiplicar</option>
<option value="screen">Tela</option>
<option value="overlay">Sobrepor</option>
<option value="darken">Escurecer</option>
<option value="lighten">Iluminar</option>
<option value="color-dodge">Lodge</option>
<option value="color-burn">Queimar</option>
<option value="hard-light">Luz Forte</option>
<option value="soft-light">Luz Fraca</option>
<option value="difference">Oposto*</option>
<option value="exclusion">Inverter*</option>
</select>
</div>
<div class="control-popup" id="font-popup">
<select id="font-select" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg h-fit w-fit p-2.5"></select>
</div>
<div class="control-popup" id="texttype-popup">
<div class="text-type-selector" style="flex-direction:column;min-width:140px;">
<button class="text-type-btn" data-type="h1" data-size="48" style="display:flex;align-items:center;gap:8px;width:100%;"><span style="font-size:18px;">Título</span><span style="font-size:11px;opacity:.7;"></span></button>
<button class="text-type-btn" data-type="h2" data-size="36" style="display:flex;align-items:center;gap:8px;width:100%;"><span style="font-size:16px;">Sub-título</span><span style="font-size:11px;opacity:.7;"></span></button>
<button class="text-type-btn" data-type="h3" data-size="28" style="display:flex;align-items:center;gap:8px;width:100%;"><span style="font-size:14px;">Tópico</span><span style="font-size:11px;opacity:.7;"></span></button>
<button class="text-type-btn" data-type="h4" data-size="24" style="display:flex;align-items:center;gap:8px;width:100%;"><span style="font-size:13px;">Sub-tópico</span><span style="font-size:11px;opacity:.7;"></span></button>
<button class="text-type-btn" data-type="h5" data-size="20" style="display:flex;align-items:center;gap:8px;width:100%;"><span style="font-size:12px;">Inferior</span><span style="font-size:11px;opacity:.7;"></span></button>
<button class="text-type-btn" data-type="h6" data-size="16" style="display:flex;align-items:center;gap:8px;width:100%;"><span style="font-size:11px;">Sub-inferior</span><span style="font-size:11px;opacity:.7;"></span></button>
<button class="text-type-btn" data-type="p" data-size="14" style="display:flex;align-items:center;gap:8px;width:100%;"><span style="font-size:11px;">Parágrafo</span><span style="font-size:11px;opacity:.7;">Parágrafo</span></button>
</div>
</div>
<!-- fontweight agora é click +100 loop, sem popup -->
<div class="hidden modal" id="gradient-modal">
<div class="modal-content">
<button class="modal-close" id="close-gradient">×</button>
<h3 class="text-lg font-bold"><i class="ri-pantone-fill"></i> Escolha um Degradê</h3>
<div class="item-grid" id="gradient-grid"></div>
</div>
</div>
<div class="hidden modal" id="templates-modal">
<div class="modal-content">
<button class="modal-close" id="close-templates">×</button>
<h3 class="text-lg font-bold"><i class="ri-stack-fill"></i> Escolha um Modelo</h3>
<div class="item-grid" id="templates-grid"></div>
</div>
</div>
<input type="file" id="image-upload" accept="image/*" class="hidden" />
<script>
document.addEventListener('DOMContentLoaded', () => {
document.addEventListener('gesturestart', e => e.preventDefault());
document.addEventListener('gesturechange', e => e.preventDefault());
fabric.Object.prototype.set({
borderColor: '#ff8c00',
cornerColor: '#ff8c00',
cornerSize: 12,
transparentCorners: false,
cornerStyle: 'circle'
});
const canvas = new fabric.Canvas('apollo-canvas', {
width: 320,
height: 568,
backgroundColor: '#f9a748',
preserveObjectStacking: true
});
fabric.Object.prototype.customBlur = 0;
fabric.Object.prototype.customBlendMode = 'normal';
const FontManager = {
fontRegistry: [
{ name: 'Sistema', fontFamily: 'system-ui', group: 'Sistema' },
{ name: '[Dismantle#1', fontFamily: 'Barriecito', value: 'google', group: 'Favs del rValle' },
{ name: '[Dismantle#2', fontFamily: 'Barrio', value: 'google', group: 'Favs del rValle' },
{ name: 'Cristo Redentor', fontFamily: 'Boldonse', value: 'google', group: 'Favs del rValle' },
{ name: 'Malhação', fontFamily: 'Chelsea Market', value: 'google', group: 'Favs del rValle' },
{ name: 'Cidade de Deus', fontFamily: 'Climate Crisis', value: 'google', group: 'Favs del rValle' },
{ name: '404error', fontFamily: 'Coral Pixels', value: 'google', group: 'Favs del rValle' },
{ name: 'Magia Negra', fontFamily: 'Fontdiner Swanky', value: 'google', group: 'Favs del rValle' },
{ name: 'Du DuDu e Edu', fontFamily: 'Frijole', value: 'google', group: 'Favs del rValle' },
{ name: 'TCC', fontFamily: 'Inter', value: 'google', group: 'Favs del rValle' },
{ name: 'Dismantle#3', fontFamily: 'Major Mono Display', value: 'google', group: 'Favs del rValle' },
{ name: 'Mose', fontFamily: 'Orbitron', value: 'google', group: 'Favs del rValle' },
{ name: 'Osmose', fontFamily: 'Traveler', value: 'https://fonts.cdnfonts.com/css/traveler', group: 'Favs del rValle' },
{ name: 'Plasma', fontFamily: 'Rubik Spray Paint', value: 'google', group: 'Favs del rValle' },
{ name: 'Plasma Traçado', fontFamily: 'Rubik Vinyl', value: 'google', group: 'Favs del rValle' },
{ name: 'Bob S.ja', fontFamily: 'Slackey', value: 'google', group: 'Favs del rValle' },
{ name: 'Confidencial', fontFamily: 'Special Elite', value: 'google', group: 'Favs del rValle' },
{ name: 'Restaurante Caro', fontFamily: 'Syncopate', value: 'google', group: 'Favs del rValle' },
{ name: 'Technos Bloks', fontFamily: 'Syne Mono', value: 'google', group: 'Favs del rValle' },
{ name: '#importante', fontFamily: 'Zilla Slab Highlight', value: 'google', group: 'Favs del rValle' },
{ name: 'Moderno Minimo', fontFamily: 'Enotria', value: 'https://fonts.cdnfonts.com/css/enotria', group: 'Museu do Amanhã' },
{ name: 'Moderno folgado', fontFamily: 'Sphere Next', value: 'https://fonts.cdnfonts.com/css/sphere-next', group: 'Museu do Amanhã' },
{ name: 'Moderno mediano?', fontFamily: 'Softline', value: 'https://fonts.cdnfonts.com/css/softline', group: 'Museu do Amanhã' },
{ name: 'Moderno Fav', fontFamily: 'Tyro Sans', value: 'https://fonts.cdnfonts.com/css/tyro-sans', group: 'Museu do Amanhã' },
{ name: 'Grego-moderno', fontFamily: 'Herova', value: 'https://fonts.cdnfonts.com/css/herova', group: 'Museu do Amanhã' },
{ name: 'ok moderno', fontFamily: 'Encode Sans SC', value: 'https://fonts.cdnfonts.com/css/encode-sans-sc', group: 'Museu do Amanhã' },
{ name: 'Hispter lucaSP', fontFamily: 'Amoera', value: 'https://fonts.cdnfonts.com/css/amoera', group: 'Museu do Amanhã' },
{ name: 'Jogos Brincadeiras', fontFamily: 'Sanshine', value: 'https://fonts.cdnfonts.com/css/sanshine-2', group: 'Universidade Federal' },
{ name: 'Lingua Portuguesa', fontFamily: 'Fjalla One', value: 'https://fonts.cdnfonts.com/css/fjalla-one-2', group: 'Universidade Federal' },
{ name: 'Geometria Satanica', fontFamily: 'Mangoli', value: 'https://fonts.cdnfonts.com/css/mangoli', group: 'Universidade Federal' },
{ name: 'Urbanismo 1', fontFamily: 'Camelin', value: 'https://fonts.cdnfonts.com/css/camelin', group: 'Universidade Federal' },
{ name: 'Dom Pedro', fontFamily: 'Belong', value: 'https://fonts.cdnfonts.com/css/belong', group: 'Biblioteca Nacional' },
{ name: 'PC em 1500', fontFamily: 'Dark Combo', value: 'https://fonts.cdnfonts.com/css/dark-combo', group: 'Biblioteca Nacional' },
{ name: 'Passado Moderno', fontFamily: 'Brotherly', value: 'https://fonts.cdnfonts.com/css/brotherly', group: 'Biblioteca Nacional' },
{ name: 'Pirata Nacional', fontFamily: 'Kings and Pirates', value: 'https://fonts.cdnfonts.com/css/kings-and-pirates', group: 'Biblioteca Nacional' },
{ name: 'ConceitualCarioca', fontFamily: 'Summer Film Festival', value: 'https://fonts.cdnfonts.com/css/summer-film-festival', group: 'Museu de Arte Contemporânea' },
{ name: 'Vibrar 1', fontFamily: 'Glitch Paradise', value: 'https://fonts.cdnfonts.com/css/glitch-paradise', group: 'Museu de Arte Contemporânea' },
{ name: 'Vibrar 2', fontFamily: 'H Higlitch', value: 'https://fonts.cdnfonts.com/css/h-higlitch', group: 'Museu de Arte Contemporânea' },
{ name: 'Vibrar 3', fontFamily: 'Nockwell', value: 'https://fonts.cdnfonts.com/css/nockwell', group: 'Museu de Arte Contemporânea' },
{ name: 'Vibrar 4', fontFamily: 'H Horey', value: 'https://fonts.cdnfonts.com/css/h-horey', group: 'Museu de Arte Contemporânea' },
{ name: 'Poça', fontFamily: 'Magical Childhood', value: 'https://fonts.cdnfonts.com/css/magical-childhood', group: 'Ponte Rio-Niterói' },
{ name: 'Joelho', fontFamily: 'Taruno Wide Med', value: 'https://fonts.cdnfonts.com/css/taruno-wide-med', group: 'Ponte Rio-Niterói' },
{ name: 'Joelho Bold', fontFamily: 'Druk Wide Bold', value: 'https://fonts.cdnfonts.com/css/druk-wide-bold', group: 'Ponte Rio-Niterói' },
{ name: 'Paz', fontFamily: 'Gasoek One', value: 'https://fonts.cdnfonts.com/css/gasoek-one', group: 'Mar' },
{ name: 'Barcas Moderna', fontFamily: 'Quirky Brewery', value: 'https://fonts.cdnfonts.com/css/quirky-brewery', group: 'Mar' },
{ name: 'Inicio do Dia', fontFamily: 'They Call Me Lazy Thinbold', value: 'https://fonts.cdnfonts.com/css/they-call-me-lazy-thinbold', group: 'Uruguaiana' },
{ name: 'MagiaDelSaara', fontFamily: 'The Punk and the Godfather', value: 'https://fonts.cdnfonts.com/css/the-punk-and-the-godfather', group: 'Uruguaiana' },
{ name: 'DisneyPopular 18+', fontFamily: 'Courier Punk Version', value: 'https://fonts.cdnfonts.com/css/courier-punk-version', group: 'Uruguaiana' },
{ name: 'Fim expediente', fontFamily: 'Times for Punks', value: 'https://fonts.cdnfonts.com/css/times-for-punks', group: 'Uruguaiana' },
{ name: '[D Central', fontFamily: 'Varia Display', value: 'https://fonts.cdnfonts.com/css/varia-display', group: 'Lapa' },
{ name: 'kd meu oculos', fontFamily: 'Kramerized', value: 'https://fonts.cdnfonts.com/css/kramerized', group: 'Lapa' },
{ name: 'Colagens', fontFamily: 'Red Screen Eye', value: 'https://fonts.cdnfonts.com/css/red-screen-eye', group: 'Lapa' },
{ name: 'kkkrezy', fontFamily: 'Party In North Korea', value: 'https://fonts.cdnfonts.com/css/party-in-north-korea', group: 'Lapa' }
],
loadedFonts: new Set(),
init() {
this.populateSelector();
this.loadGoogleFonts();
},
populateSelector() {
const groups = {};
this.fontRegistry.forEach(font => {
if (!groups[font.group]) groups[font.group] = [];
groups[font.group].push(font);
});
let html = '<option value="0">Sistema</option>';
Object.keys(groups).sort().forEach(groupName => {
if (groupName !== 'Sistema') {
html += `<optgroup label="${groupName}">`;
groups[groupName].forEach(font => {
const fontIndex = this.fontRegistry.indexOf(font);
html += `<option value="${fontIndex}">${font.name}</option>`;
});
html += '</optgroup>';
}
});
document.getElementById('font-select').innerHTML = html;
},
loadGoogleFonts() {
const googleFonts = this.fontRegistry
.filter(f => f.value === 'google')
.map(f => f.fontFamily.replace(' ', '+'))
.join('|');
if (googleFonts) {
const link = document.createElement('link');
link.rel = 'stylesheet';
link.href = `https://fonts.googleapis.com/css?family=${googleFonts}:400,700,900&display=swap`;
document.head.appendChild(link);
}
this.fontRegistry.forEach(font => {
if (font.value && font.value.startsWith('http')) {
this.loadCDNFont(font.value);
}
});
},
loadCDNFont(url) {
if (!this.loadedFonts.has(url)) {
const link = document.createElement('link');
link.rel = 'stylesheet';
link.href = url;
document.head.appendChild(link);
this.loadedFonts.add(url);
}
}
};
FontManager.init();
const R = {
canvasWrapper: document.getElementById('canvas-wrapper'),
downloadBtn: document.getElementById('download-btn'),
balDropper: document.getElementById('bal-dropper'),
buildBtn: document.getElementById('build-btn'),
buildPanel: document.getElementById('build-panel'),
templatesBtn: document.getElementById('templates-btn'),
templatesModal: document.getElementById('templates-modal'),
closeTemplates: document.getElementById('close-templates'),
templatesGrid: document.getElementById('templates-grid'),
ratioBtn: document.getElementById('ratio-btn'),
gradientBtn: document.getElementById('gradient-btn'),
gradientModal: document.getElementById('gradient-modal'),
closeGradient: document.getElementById('close-gradient'),
gradientGrid: document.getElementById('gradient-grid'),
deleteBtn: document.getElementById('delete-btn'),
addTextBtn: document.getElementById('add-text-btn'),
addImageBtn: document.getElementById('add-image-btn'),
addBoxBtn: document.getElementById('add-box-btn'),
imageUpload: document.getElementById('image-upload'),
elementControls: document.getElementById('element-controls'),
elemColorInput: document.getElementById('elem-color-input'),
elemColorCircle: document.getElementById('elem-color-circle'),
elemBorderBtn: document.getElementById('elem-border-btn'),
borderPopup: document.getElementById('border-popup'),
borderSlider: document.getElementById('border-slider'),
borderValue: document.getElementById('border-value'),
elemOpacityBtn: document.getElementById('elem-opacity-btn'),
opacityPopup: document.getElementById('opacity-popup'),
opacitySlider: document.getElementById('opacity-slider'),
opacityValue: document.getElementById('opacity-value'),
elemBlurBtn: document.getElementById('elem-blur-btn'),
blurPopup: document.getElementById('blur-popup'),
blurSlider: document.getElementById('blur-slider'),
blurValue: document.getElementById('blur-value'),
elemBlendBtn: document.getElementById('elem-blend-btn'),
blendPopup: document.getElementById('blend-popup'),
blendSelect: document.getElementById('blend-select'),
elemFontBtn: document.getElementById('elem-font-btn'),
fontPopup: document.getElementById('font-popup'),
fontSelect: document.getElementById('font-select'),
elemTexttypeBtn: document.getElementById('elem-texttype-btn'),
texttypePopup: document.getElementById('texttype-popup'),
elemFontweightBtn: document.getElementById('elem-fontweight-btn'),
elemFontsizeBtn: document.getElementById('elem-fontsize-btn'),
fontsizePopup: document.getElementById('fontsize-popup'),
fontsizeSlider: document.getElementById('fontsize-slider'),
fontsizeValue: document.getElementById('fontsize-value'),
alignBtn: document.getElementById('align-btn'),
layerUpBtn: document.getElementById('layer-up-btn'),
layerDownBtn: document.getElementById('layer-down-btn'),
bgColor: document.getElementById('bg-color'),
transparentBgToggle: document.getElementById('transparent-bg-toggle'),
undoBtn: document.getElementById('undo-btn'),
redoBtn: document.getElementById('redo-btn')
};

// ============ UNDO/REDO HISTORY MANAGER ============
const HistoryManager = {
  undoStack: [],
  redoStack: [],
  maxHistory: 50,
  isRestoring: false,
  
  init(canvas) {
    this.canvas = canvas;
    // Save initial state
    this.saveState();
    // Listen for canvas changes
    canvas.on('object:added', () => this.onCanvasChange());
    canvas.on('object:modified', () => this.onCanvasChange());
    canvas.on('object:removed', () => this.onCanvasChange());
  },
  
  onCanvasChange() {
    if (!this.isRestoring) {
      this.saveState();
    }
  },
  
  saveState() {
    const json = this.canvas.toJSON(['customBlur', 'customBlendMode', 'customTextType']);
    this.undoStack.push(JSON.stringify(json));
    if (this.undoStack.length > this.maxHistory) {
      this.undoStack.shift();
    }
    // Clear redo stack when new action is performed
    this.redoStack = [];
    this.updateButtons();
  },
  
  undo() {
    if (this.undoStack.length <= 1) return;
    const current = this.undoStack.pop();
    this.redoStack.push(current);
    const previous = this.undoStack[this.undoStack.length - 1];
    this.restoreState(previous);
    this.updateButtons();
  },
  
  redo() {
    if (this.redoStack.length === 0) return;
    const next = this.redoStack.pop();
    this.undoStack.push(next);
    this.restoreState(next);
    this.updateButtons();
  },
  
  restoreState(stateJson) {
    this.isRestoring = true;
    this.canvas.loadFromJSON(JSON.parse(stateJson), () => {
      this.canvas.renderAll();
      this.isRestoring = false;
    });
  },
  
  updateButtons() {
    R.undoBtn.disabled = this.undoStack.length <= 1;
    R.redoBtn.disabled = this.redoStack.length === 0;
  }
};

// Initialize history manager
HistoryManager.init(canvas);

// Undo/Redo button handlers
R.undoBtn.addEventListener('click', () => HistoryManager.undo());
R.redoBtn.addEventListener('click', () => HistoryManager.redo());
canvas.on('selection:created', updateControls);
canvas.on('selection:updated', updateControls);
canvas.on('selection:cleared', hideControls);
canvas.on('object:modified', applyEffects);
function applyEffects() {
const obj = canvas.getActiveObject();
if (obj) {
const blur = obj.customBlur || 0;
const blend = obj.customBlendMode || 'normal';
obj.set({
filter: blur > 0 ? new fabric.Image.filters.Blur({ blur: blur/10 }) : null,
globalCompositeOperation: blend
});
canvas.requestRenderAll();
}
}
function updateControls() {
const obj = canvas.getActiveObject();
if (!obj) return;
R.elementControls.classList.add('active');
const isText = obj.type === 'i-text' || obj.type === 'textbox';
const isImage = obj.type === 'image';
const isShape = obj.type === 'rect' || obj.type === 'circle';
// Remove all type classes first
R.elementControls.classList.remove('text-active', 'box-active', 'image-active');
if (isText) {
R.elementControls.classList.add('text-active');
R.elemColorInput.value = obj.fill || '#000000';
R.fontsizeSlider.value = obj.fontSize || 24;
R.fontsizeValue.textContent = obj.fontSize || 24;
const fontIndex = FontManager.fontRegistry.findIndex(f => f.fontFamily === obj.fontFamily);
R.fontSelect.value = fontIndex >= 0 ? fontIndex : 0;
} else if (isImage) {
R.elementControls.classList.add('image-active');
R.elemColorInput.value = '#ffffff';
} else {
R.elementControls.classList.add('box-active');
R.elemColorInput.value = obj.fill || '#ffffff';
R.borderSlider.value = obj.rx || 0;
R.borderValue.textContent = obj.rx || 0;
}
R.opacitySlider.value = Math.round((obj.opacity || 1) * 100);
R.opacityValue.textContent = R.opacitySlider.value;
R.blurSlider.value = obj.customBlur || 0;
R.blurValue.textContent = R.blurSlider.value;
R.blendSelect.value = obj.customBlendMode || 'normal';
R.elemColorCircle.style.background = R.elemColorInput.value;
}
function hideControls() {
R.elementControls.classList.remove('active', 'text-active', 'box-active', 'image-active');
closeAllPopups();
}
function closeAllPopups() {
[R.borderPopup, R.opacityPopup, R.blurPopup, R.blendPopup, R.fontPopup, R.fontsizePopup, R.texttypePopup].forEach(p => p && p.classList.remove('active'));
}
function togglePopup(popup, btn) {
const was = popup.classList.contains('active');
closeAllPopups();
if (!was) {
popup.classList.add('active');
const rect = btn.getBoundingClientRect();
popup.style.top = `${rect.top}px`;
popup.style.left = `${rect.right + 10}px`;
}
}
R.addTextBtn.addEventListener('click', () => {
const text = new fabric.IText('Apollo Rio', {
left: 80,
top: 100,
fontSize: 28,
fill: '#000',
fontFamily: 'system-ui',
fontWeight: 500
});
canvas.add(text);
canvas.setActiveObject(text);
canvas.renderAll();
R.buildPanel.classList.remove('active');
});
R.addBoxBtn.addEventListener('click', () => {
const rect = new fabric.Rect({
left: 80,
top: 150,
width: 150,
height: 150,
fill: '#ffffff',
rx: 0,
ry: 0
});
canvas.add(rect);
canvas.setActiveObject(rect);
canvas.renderAll();
R.buildPanel.classList.remove('active');
});
R.addImageBtn.addEventListener('click', () => R.imageUpload.click());
R.imageUpload.addEventListener('change', (e) => {
if (e.target.files && e.target.files[0]) {
const reader = new FileReader();
reader.onload = (ev) => {
fabric.Image.fromURL(ev.target.result, (img) => {
img.scaleToWidth(150);
img.set({ left: 60, top: 200 });
canvas.add(img);
canvas.setActiveObject(img);
canvas.renderAll();
});
};
reader.readAsDataURL(e.target.files[0]);
}
R.buildPanel.classList.remove('active');
});
R.deleteBtn.addEventListener('click', () => {
const obj = canvas.getActiveObject();
if (obj) {
canvas.remove(obj);
canvas.renderAll();
}
});
R.bgColor.addEventListener('input', (e) => {
canvas.setBackgroundColor(e.target.value, canvas.renderAll.bind(canvas));
e.target.parentElement.style.background = e.target.value;
});
R.elemColorInput.addEventListener('input', (e) => {
const obj = canvas.getActiveObject();
if (obj) {
obj.set('fill', e.target.value);
canvas.renderAll();
R.elemColorCircle.style.background = e.target.value;
}
});
R.opacitySlider.addEventListener('input', (e) => {
const obj = canvas.getActiveObject();
if (obj) {
const opacity = parseInt(e.target.value) / 100;
obj.set('opacity', opacity);
canvas.renderAll();
R.opacityValue.textContent = e.target.value;
}
});
R.borderSlider.addEventListener('input', (e) => {
const obj = canvas.getActiveObject();
if (obj && (obj.type === 'rect' || obj.type === 'image')) {
const radius = parseInt(e.target.value);
if (obj.type === 'rect') {
obj.set({ rx: radius, ry: radius });
} else if (obj.type === 'image') {
obj.set({
clipPath: new fabric.Rect({
width: obj.width,
height: obj.height,
rx: radius/obj.scaleX,
ry: radius/obj.scaleY,
originX: 'center',
originY: 'center'
})
});
}
canvas.renderAll();
R.borderValue.textContent = radius;
}
});
R.blurSlider.addEventListener('input', (e) => {
const obj = canvas.getActiveObject();
if (obj) {
const blur = parseInt(e.target.value);
obj.customBlur = blur;
if (blur > 0) {
const blurFilter = new fabric.Image.filters.Blur({ blur: blur/10 });
obj.filters = [blurFilter];
obj.applyFilters();
} else {
obj.filters = [];
obj.applyFilters();
}
canvas.renderAll();
R.blurValue.textContent = blur;
}
});
R.blendSelect.addEventListener('change', (e) => {
const obj = canvas.getActiveObject();
if (obj) {
obj.customBlendMode = e.target.value;
obj.globalCompositeOperation = e.target.value;
canvas.renderAll();
}
});
R.fontsizeSlider.addEventListener('input', (e) => {
const obj = canvas.getActiveObject();
if (obj && (obj.type === 'i-text' || obj.type === 'textbox')) {
obj.set('fontSize', parseInt(e.target.value));
canvas.renderAll();
R.fontsizeValue.textContent = e.target.value;
}
});
R.fontSelect.addEventListener('change', (e) => {
const obj = canvas.getActiveObject();
if (obj && (obj.type === 'i-text' || obj.type === 'textbox')) {
const font = FontManager.fontRegistry[parseInt(e.target.value)];
if (font) {
obj.set('fontFamily', font.fontFamily);
canvas.renderAll();
}
}
});

// Text type selector (H1-H6, P)
document.querySelectorAll('.text-type-btn').forEach(btn => {
btn.addEventListener('click', () => {
const obj = canvas.getActiveObject();
if (obj && (obj.type === 'i-text' || obj.type === 'textbox')) {
const size = parseInt(btn.dataset.size);
const type = btn.dataset.type;
const fontWeight = type === 'p' ? 400 : (type === 'h1' || type === 'h2' ? 700 : 600);
obj.set({ fontSize: size, fontWeight: fontWeight });
obj.customTextType = type;
canvas.renderAll();
R.fontsizeSlider.value = size;
R.fontsizeValue.textContent = size;
// Update active state
document.querySelectorAll('.text-type-btn').forEach(b => b.classList.remove('active'));
btn.classList.add('active');
closeAllPopups();
}
});
});

// Font weight - click +100 loop (100-900, then back to 100)
R.elemFontweightBtn.addEventListener('click', () => {
const obj = canvas.getActiveObject();
if (obj && (obj.type === 'i-text' || obj.type === 'textbox')) {
let currentWeight = parseInt(obj.fontWeight) || 400;
let newWeight = currentWeight + 100;
if (newWeight > 900) newWeight = 100; // Loop back to 100
obj.set('fontWeight', newWeight);
canvas.renderAll();
}
});

// Transparent background toggle (BEACH TOGGLE)
let transparentBgEnabled = false;
R.transparentBgToggle.addEventListener('click', () => {
transparentBgEnabled = !transparentBgEnabled;
R.transparentBgToggle.classList.toggle('beach-toggle--active', transparentBgEnabled);
if (transparentBgEnabled) {
// Show checkered pattern for transparency preview on canvas wrapper
R.canvasWrapper.style.backgroundImage = 'linear-gradient(45deg, #ccc 25%, transparent 25%), linear-gradient(-45deg, #ccc 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #ccc 75%), linear-gradient(-45deg, transparent 75%, #ccc 75%)';
R.canvasWrapper.style.backgroundSize = '20px 20px';
R.canvasWrapper.style.backgroundPosition = '0 0, 0 10px, 10px -10px, -10px 0px';
} else {
R.canvasWrapper.style.backgroundImage = 'none';
}
});

const aligns = ['left', 'center', 'right'];
R.alignBtn.addEventListener('click', () => {
const obj = canvas.getActiveObject();
if (obj && (obj.type === 'i-text' || obj.type === 'textbox')) {
const current = obj.textAlign || 'left';
const idx = (aligns.indexOf(current) + 1) % aligns.length;
obj.set('textAlign', aligns[idx]);
canvas.renderAll();
}
});
R.layerUpBtn.addEventListener('click', () => {
const obj = canvas.getActiveObject();
if (obj) {
canvas.bringForward(obj);
canvas.renderAll();
}
});
R.layerDownBtn.addEventListener('click', () => {
const obj = canvas.getActiveObject();
if (obj) {
canvas.sendBackwards(obj);
canvas.renderAll();
}
});
R.elemBorderBtn.onclick = (e) => togglePopup(R.borderPopup, e.currentTarget);
R.elemOpacityBtn.onclick = (e) => togglePopup(R.opacityPopup, e.currentTarget);
R.elemBlurBtn.onclick = (e) => togglePopup(R.blurPopup, e.currentTarget);
R.elemBlendBtn.onclick = (e) => togglePopup(R.blendPopup, e.currentTarget);
R.elemFontBtn.onclick = (e) => togglePopup(R.fontPopup, e.currentTarget);
R.elemFontsizeBtn.onclick = (e) => togglePopup(R.fontsizePopup, e.currentTarget);
R.elemTexttypeBtn.onclick = (e) => togglePopup(R.texttypePopup, e.currentTarget);
R.buildBtn.addEventListener('click', () => {
closeAllPopups();
R.buildPanel.classList.toggle('active');
});
R.ratioBtn.addEventListener('click', () => {
R.canvasWrapper.classList.toggle('ratio-square');
const isSquare = R.canvasWrapper.classList.contains('ratio-square');
canvas.setDimensions({
width: isSquare ? 400 : 320,
height: isSquare ? 400 : 568
});


R.canvasWrapper.addEventListener('drop', (e) => {
  e.preventDefault();
  const imageUrl = e.dataTransfer.getData('image/url') || R.balDropper.src;
  fabric.Image.fromURL(imageUrl, (img) => {
    img.scaleToWidth(80);
    img.set({
      left: e.offsetX - 40,
      top: e.offsetY - 40
    });
    canvas.add(img);
    canvas.renderAll();
  });
});

canvas.renderAll();
});
// ============ MOBILE TEXT EDITING IMPROVEMENT ============
// Allow native text selection when editing IText objects
// Only prevent default when NOT editing text to allow proper text selection on mobile

let isTextEditing = false;

canvas.on('text:editing:entered', () => {
    isTextEditing = true;
    // Enable text selection on mobile - add class for CSS override
    document.body.classList.add('text-editing-mode');
    R.canvasWrapper.style.touchAction = 'auto';
});

canvas.on('text:editing:exited', () => {
    isTextEditing = false;
    // Restore default behavior - remove class
    document.body.classList.remove('text-editing-mode');
    R.canvasWrapper.style.touchAction = 'none';
});

// Smart touch handlers - only block when NOT editing text
R.canvasWrapper.addEventListener('touchstart', function(e) {
    // Allow native behavior when editing text (for cursor positioning and selection)
    if (isTextEditing) return;
    // Don't prevent default - let fabric.js handle touch events
}, { passive: true });

R.canvasWrapper.addEventListener('touchmove', function(e) {
    // Allow native behavior when editing text (for text selection)
    if (isTextEditing) return;
    // Don't prevent default during normal canvas interaction
}, { passive: true });

R.canvasWrapper.addEventListener('touchend', function(e) {
    // Allow native behavior when editing text
    if (isTextEditing) return;
}, { passive: true });

// Modify existing drag events to support both mouse and touch
R.balDropper.addEventListener('dragstart', (e) => {
    e.dataTransfer.effectAllowed = 'copy';
    e.dataTransfer.setData('image/url', R.balDropper.src);
});

R.canvasWrapper.addEventListener('dragover', (e) => {
    e.preventDefault();
    e.dataTransfer.dropEffect = 'copy';
});

R.canvasWrapper.addEventListener('drop', (e) => {
    e.preventDefault();
    const imageUrl = e.dataTransfer.getData('image/url') || R.balDropper.src;
    fabric.Image.fromURL(imageUrl, (img) => {
        img.scaleToWidth(80);
        img.set({
            left: e.offsetX - 40,
            top: e.offsetY - 40
        });
        canvas.add(img);
        canvas.renderAll();
    });
});
const templates = [
{
name: "Duo P&B",
background: '#eaddd0',
elements: [
{ type: 'circle', radius: 140, left: 20, top: 144, fill: '#000000' },
{ type: 'text', text: 'APOLLO', left: 0, top: 100, fontSize: 80, fontWeight: '900', fill: '#ffffff', fontFamily: 'system-ui', mixBlendMode: 'difference' },
{ type: 'text', text: 'Creative', left: 10, top: 340, fontSize: 60, fontWeight: '900', fill: '#ffffff', fontFamily: 'system-ui', mixBlendMode: 'difference' },
{ type: 'text', text: 'Studio', left: 10, top: 400, fontSize: 60, fontWeight: '900', fill: '#000000', fontFamily: 'system-ui' }
]
},
{
name: "Brilha",
background: '#eaddd0',
elements: [
{ type: 'text', text: '~', left: 70, top: 220, fontSize: 105, fontWeight: '700', fill: '#8c36a3', fontFamily: 'system-ui' }
]
},
{
name: "Apollo::rio",
background: '#eaddd0',
elements: [
{ type: 'text', text: 'AM', fontFamily: 'system-ui', fontSize: 320, fontWeight: '900', fill: '#27a281', left: -50, top: 0 },
{ type: 'text', text: 'STUDIO', left: 10, top: 40, fontSize: 50, fontWeight: '900', fill: '#27a281', fontFamily: 'system-ui' },
{ type: 'text', text: 'criativo', left: 10, top: 400, fontSize: 50, fontWeight: '900', fill: '#000000', fontFamily: 'system-ui' }
]
},
{
name: "fé",
background: '#eaddd0',
elements: [
{ type: 'circle', radius: 225, left: -150, top: 200, fill: '#0d69b3' },
{ type: 'circle', radius: 150, left: 50, top: -50, fill: '#0a548c' },
{ type: 'text', text: 'no silêncio do mar,\nmeus gritos\nencontram casa..', left: 42, top: 38, fontSize: 49, fontWeight: '700', fill: '#eaddd0', fontFamily: 'system-ui', textAlign: 'left' },
{ type: 'text', text: 'fé', left: 20, top: 450, fontSize: 28, fontWeight: '700', fill: '#eaddd0', fontFamily: 'system-ui' }
]
},
{
name: "apollo",
background: '#eaddd0',
elements: [
{ type: 'rect', width: 160, height: 220, left: 10, top: 10, fill: '#d83633' },
{ type: 'rect', width: 160, height: 328, left: 10, top: 230, fill: '#d83633' },
{ type: 'rect', width: 80, height: 100, left: 10, top: 230, fill: '#eaddd0' },
{ type: 'rect', width: 140, height: 328, left: 170, top: 230, fill: '#d83633', rx: 70, ry: 70 },
{ type: 'text', text: 'A', left: 170, top: 10, fontSize: 250, fontWeight: '900', fill: '#d83633', fontFamily: 'system-ui' },
{ type: 'text', text: 'llo', left: 35, top: 466, fontSize: 90, fontWeight: '900', fill: '#eaddd0', fontFamily: 'system-ui' }
]
}
];
function loadTemplate(tpl) {
canvas.clear();
if (tpl.background.includes('gradient')) {
const gradient = new fabric.Gradient({
type: 'linear',
coords: { x1: 0, y1: 0, x2: canvas.width, y2: canvas.height },
colorStops: [
{ offset: 0, color: '#667eea' },
{ offset: 1, color: '#764ba2' }
]
});
canvas.setBackgroundColor(gradient, canvas.renderAll.bind(canvas));
} else {
canvas.setBackgroundColor(tpl.background, canvas.renderAll.bind(canvas));
}
R.bgColor.value = tpl.background.startsWith('#') ? tpl.background : '#ffffff';
tpl.elements.forEach(el => {
if (el.type === 'text') {
const text = new fabric.IText(el.text, {
left: el.left,
top: el.top,
fontSize: el.fontSize,
fill: el.fill,
fontFamily: el.fontFamily,
fontWeight: el.fontWeight,
textAlign: el.textAlign || 'center',
customBlendMode: el.mixBlendMode || 'normal',
globalCompositeOperation: el.mixBlendMode || 'source-over'
});
canvas.add(text);
} else if (el.type === 'rect') {
const rect = new fabric.Rect({
left: el.left,
top: el.top,
width: el.width,
height: el.height,
fill: el.fill,
rx: el.rx || 0,
ry: el.ry || 0
});
canvas.add(rect);
} else if (el.type === 'circle') {
const circle = new fabric.Circle({
left: el.left,
top: el.top,
radius: el.radius,
fill: el.fill
});
canvas.add(circle);
}
});
canvas.renderAll();
R.templatesModal.classList.add('hidden');
}
templates.forEach(tpl => {
const card = document.createElement('div');
card.className = 'grid-item template-preview';
const prev = document.createElement('div');
prev.style.cssText = `position:relative;width:100%;height:100%;background:${tpl.background};overflow:hidden;`;
const ov = document.createElement('div');
ov.className = 'preview-overlay';
ov.textContent = tpl.name;
card.appendChild(prev);
card.appendChild(ov);
card.onclick = () => loadTemplate(tpl);
R.templatesGrid.appendChild(card);
});
R.templatesBtn.addEventListener('click', () => {
closeAllPopups();
R.templatesModal.classList.remove('hidden');
});
R.closeTemplates.addEventListener('click', () =>
R.templatesModal.classList.add('hidden')
);
const gradients = [
{ start: '#6DE195', end: '#C4E759' },
{ start: '#41C7AF', end: '#54E38E' },
{ start: '#99E5A2', end: '#D4FC78' },
{ start: '#ABC7FF', end: '#C1E3FF' },
{ start: '#6CACFF', end: '#8DEBFF' },
{ start: '#5583EE', end: '#41D8DD' },
{ start: '#A16BFE', end: '#DEB0DF' },
{ start: '#D279EE', end: '#F8C390' },
{ start: '#F78FAD', end: '#FDEB82' },
{ start: '#BC3D2F', end: '#A16BFE' },
{ start: '#A43AB2', end: '#E13680' },
{ start: '#9D2E7D', end: '#E16E93' },
{ start: '#F5CCF6', end: '#F1EEF9' },
{ start: '#F0EFF0', end: '#FAF8F9' },
{ start: '#121317', end: '#323B42' },
{ start: '#0ba360', end: '#3cba92' },
{ start: '#00b09b', end: '#96c93d' },
{ start: '#ffe000', end: '#799f0c' },
{ start: '#abbaab', end: '#ffffff' },
{ start: '#8e9eab', end: '#eef2f3' },
{ start: '#29323c', end: '#485563' },
{ start: '#2af598', end: '#009efd' },
{ start: '#1e3c72', end: '#2a5298' },
{ start: '#4facfe', end: '#00f2fe' },
{ start: '#667eea', end: '#764ba2' },
{ start: '#89f7fe', end: '#66a6ff' },
{ start: '#4ca1af', end: '#c4e0e5' },
{ start: '#2bc0e4', end: '#eaecc6' },
{ start: '#1c92d2', end: '#f2fcfe' },
{ start: '#cfd9df', end: '#e2ebf0' },
{ start: '#FFFFFF', end: '#2980B9' },
{ start: '#ffe387', end: '#ffefba' },
{ start: '#ece9e6', end: '#ffffff' },
{ start: '#fceabb', end: '#f8b500' },
{ start: '#fc4a1a', end: '#f7b733' },
{ start: '#f12711', end: '#f5af19' },
{ start: '#ffe259', end: '#ffa751' },
{ start: '#fccb90', end: '#d57eeb' },
{ start: '#a6c0fe', end: '#f68084' },
{ start: '#f78ca0', end: '#fe9a8b' },
{ start: '#fffbd5', end: '#b20a2c' },
{ start: '#ff0844', end: '#ffb199' },
{ start: '#e0c3fc', end: '#8ec5fc' },
{ start: '#f093fb', end: '#f5576c' },
{ start: '#c471f5', end: '#fa71cd' },
{ start: '#2b5876', end: '#4e4376' },
{ start: '#141e30', end: '#243b55' },
{ start: '#0f2027', end: '#2c5364' },
{ start: '#434343', end: '#000000' },
{ start: '#603813', end: '#b29f94' },
{ start: '#ff8008', end: '#ffc837' },
{ start: '#ff7e5f', end: '#feb47b' },
{ start: '#cb2d3e', end: '#ef473a' },
{ start: '#ff416c', end: '#ff4b2b' },
{ start: '#8e2de2', end: '#4a00e0' },
{ start: '#7b4397', end: '#dc2430' }
];
gradients.forEach((g) => {
const d = document.createElement('div');
d.className = 'grid-item';
d.style.background = `linear-gradient(135deg, ${g.start}, ${g.end})`;
d.onclick = () => {
const gradient = new fabric.Gradient({
type: 'linear',
coords: { x1: 0, y1: 0, x2: canvas.width, y2: canvas.height },
colorStops: [
{ offset: 0, color: g.start },
{ offset: 1, color: g.end }
]
});
canvas.setBackgroundColor(gradient, canvas.renderAll.bind(canvas));
document.querySelector('#bg-color').parentElement.style.background = `linear-gradient(135deg, ${g.start}, ${g.end})`;
R.gradientModal.classList.add('hidden');
};
R.gradientGrid.appendChild(d);
});
R.gradientBtn.addEventListener('click', () => {
closeAllPopups();
R.gradientModal.classList.remove('hidden');
});
R.closeGradient.addEventListener('click', () =>
R.gradientModal.classList.add('hidden')
);
R.downloadBtn.addEventListener('click', () => {
    // Deselect active object to hide selection borders
    canvas.discardActiveObject();
    canvas.renderAll();
    
    // Show loading state
    R.downloadBtn.disabled = true;
    const originalIcon = R.downloadBtn.innerHTML;
    R.downloadBtn.innerHTML = '<i class="ri-loader-4-line" style="animation: spin 1s linear infinite;"></i>';
    
    // Store original background
    const originalBg = canvas.backgroundColor;
    
    try {
        // If transparent PNG mode is enabled, temporarily remove background
        if (transparentBgEnabled) {
            canvas.setBackgroundColor(null, canvas.renderAll.bind(canvas));
        }
        
        // Wait for canvas to fully render
        setTimeout(() => {
            // Use fabric.js native toDataURL - this ALWAYS captures all canvas content
            const dataURL = canvas.toDataURL({
                format: 'png',
                quality: 1,
                multiplier: 6, // 6x scale for 4K+ quality
                enableRetinaScaling: true
            });
            
            // Create download link
            const link = document.createElement('a');
            link.href = dataURL;
            link.download = transparentBgEnabled 
                ? `apollo-transparent-4k-${Date.now()}.png` 
                : `apollo-4k-${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Restore original background if it was changed
            if (transparentBgEnabled && originalBg) {
                canvas.setBackgroundColor(originalBg, canvas.renderAll.bind(canvas));
            }
            
            // Restore button state
            R.downloadBtn.innerHTML = originalIcon;
            R.downloadBtn.disabled = false;
        }, 100);
        
    } catch (error) {
        console.error('Export failed:', error);
        // Restore original background if needed
        if (transparentBgEnabled && originalBg) {
            canvas.setBackgroundColor(originalBg, canvas.renderAll.bind(canvas));
        }
        // Restore button state on error
        R.downloadBtn.innerHTML = originalIcon;
        R.downloadBtn.disabled = false;
        alert('Erro ao exportar imagem. Tente novamente.');
    }
});
document.addEventListener('click', (e) => {
const inside = e.target.closest('.side-menu') ||
e.target.closest('.slide-panel') ||
e.target.closest('.element-controls') ||
e.target.closest('.control-popup') ||
e.target.closest('.modal') ||
e.target.closest('.top-menu') ||
e.target.closest('canvas');
if (!inside) {
R.buildPanel.classList.remove('active');
closeAllPopups();
 }
    });

    let copiedObject = null;
    document.addEventListener('keydown', function(e) {
        // Undo (Ctrl+Z)
        if (e.ctrlKey && e.key === 'z' && !e.shiftKey) {
            e.preventDefault();
            HistoryManager.undo();
            return;
        }
        // Redo (Ctrl+Y or Ctrl+Shift+Z)
        if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'z')) {
            e.preventDefault();
            HistoryManager.redo();
            return;
        }
        // Delete key handler
        if (e.key === 'Delete') {
            const activeObject = canvas.getActiveObject();
            if (activeObject) {
                canvas.remove(activeObject);
                canvas.renderAll();
            }
        }
        // Copy (Ctrl+C)
        if (e.ctrlKey && e.key === 'c') {
            const activeObject = canvas.getActiveObject();
            if (activeObject) {
                activeObject.clone(function(clonedObj) {
                    copiedObject = clonedObj;
                });
            }
        }
        // Paste (Ctrl+V)
        if (e.ctrlKey && e.key === 'v') {
            if (copiedObject) {
                copiedObject.clone(function(clonedObj) {
                    canvas.discardActiveObject();
                    
                    // Adjust position for visibility
                    clonedObj.set({
                        left: clonedObj.left + 10,
                        top: clonedObj.top + 10,
                        evented: true
                    });
                    // Handle different object types
                    if (clonedObj.type === 'image') {
                        canvas.add(clonedObj);
                    } else if (clonedObj.type === 'i-text' || clonedObj.type === 'textbox') {
                        // For text, create a new text object with same properties
                        const newText = new fabric.IText(clonedObj.text, {
                            left: clonedObj.left,
                            top: clonedObj.top,
                            fontSize: clonedObj.fontSize,
                            fill: clonedObj.fill,
                            fontFamily: clonedObj.fontFamily,
                            fontWeight: clonedObj.fontWeight
                        });
                        canvas.add(newText);
                        canvas.setActiveObject(newText);
                    } else {
                        // For shapes and other objects
                        canvas.add(clonedObj);
                    }
                    canvas.renderAll();
                });
            }
            // Paste (Ctrl+V)
if (e.ctrlKey && e.key === 'v') {
    // Try to paste from clipboard
    navigator.clipboard.read().then(clipboardItems => {
        for (const clipboardItem of clipboardItems) {
            for (const type of clipboardItem.types) {
                if (type.startsWith('image/')) {
                    clipboardItem.getType(type).then(blob => {
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            fabric.Image.fromURL(ev.target.result, (img) => {
                                img.scaleToWidth(150);
                                img.set({ 
                                    left: 60, 
                                    top: 200 
                                });
                                canvas.add(img);
                                canvas.setActiveObject(img);
                                canvas.renderAll();
                            });
                        };
                        reader.readAsDataURL(blob);
                    });
                    return; // Exit after first image
                }
            }
        }
    }).catch(err => {
        console.error('Failed to read clipboard', err);
    });
}
        }
    });

    loadTemplate(templates[0]);
});
</script>

<script>
    
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
      .then(reg => console.log('SW registrador:', reg))
      .catch(err => console.error('SW falhou:', err));  }
</script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ad758107ef5df39',t:'MTc2NTY0ODY0Nw=='};var a=document.createElement('script');a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script><script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"version":"2024.11.0","token":"6f9fe350d9f7425796d640adb85decb2","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>
