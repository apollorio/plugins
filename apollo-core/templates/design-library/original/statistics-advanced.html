<!DOCTYPE html>
<!--
================================================================================
APOLLO TEMPLATE: ADVANCED STATISTICS DASHBOARD
================================================================================
PHP: templates/shortcode-statistics.php | Shortcode: [apollo_statistics]

@BLOCKS: HEADER, STATS_ROW, CHARTS_COLUMN, DATA_GRID
@WIDGETS: STAT_CARD, FILTER_TABS, SEARCH, CHART_CARD
@CHARTS: PIE (position), BAR (trends), DOUGHNUT (distribution)
@LAYOUTS: sidebar-charts + main-grid (responsive)

PHP VARS: 
  - $data_source (array: events, users, djs, venues, etc.)
  - $stats_summary (array: totals, averages, changes)
  - $filter_options (array: categories, types, status)
  - $date_range (start_date, end_date)

EXTERNAL DEPENDENCIES:
  - AG Grid Community: https://cdnjs.cloudflare.com/ajax/libs/ag-grid/31.0.0/
  - Chart.js: https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/

CLASSES UNI.CSS USADAS:
  .ap-stats-dashboard, .ap-stats-header
  .ap-stats-row, .ap-stat-card, .ap-stat-mini
  .ap-stats-layout, .ap-charts-column, .ap-grid-column
  .ap-chart-card, .ap-chart-wrapper
  .ap-filter-tabs, .ap-tab-pill
  .ap-data-grid, .ap-grid-wrapper
  .ap-badge-rising, .ap-badge-falling, .ap-badge-stable

APOLLO THEME INTEGRATION:
  - Uses --ap-* CSS variables
  - AG Grid custom theme: .ap-ag-theme
  - Chart.js Apollo color palette
================================================================================
-->
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Apollo :: Estatísticas Avançadas</title>

  <!-- UNI.CSS Global Design System -->
  <link rel="stylesheet" href="https://assets.apollo.rio.br/uni.css">
  <script src="https://assets.apollo.rio.br/base.js" defer></script>
  
  <!-- RemixIcon -->
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.7.0/fonts/remixicon.css" rel="stylesheet">

  <!-- AG Grid (Data Table) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ag-grid/31.0.0/ag-grid-community.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ag-grid/31.0.0/styles/ag-grid.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ag-grid/31.0.0/styles/ag-theme-quartz.min.css">
  
  <!-- Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>

<body class="ap-stats-body">
  <div class="ap-stats-dashboard">
    
    <!-- ====================================================================
         [HEADER] Dashboard Header
         ==================================================================== -->
    <header class="ap-stats-header">
      <div class="ap-stats-header-info">
        <h1 class="ap-heading-1">Estatísticas Avançadas</h1>
        <!-- @PHP: echo esc_html($page_subtitle ?? 'Acompanhe métricas e performance') -->
        <p class="ap-text-muted">Acompanhe métricas e performance do sistema</p>
      </div>
      <div class="ap-stats-header-actions">
        <!-- @PHP: Date range picker -->
        <div class="ap-date-range" data-ap-tooltip="Período de análise">
          <i class="ri-calendar-line"></i>
          <span>2024-2025</span>
        </div>
        <button class="ap-btn ap-btn-outline-sm" data-ap-tooltip="Exportar relatório">
          <i class="ri-download-line"></i>
          Exportar
        </button>
      </div>
    </header>

    <!-- ====================================================================
         [STATS ROW] Key Metrics Cards
         PHP: foreach($stats_summary as $stat)
         ==================================================================== -->
    <div class="ap-stats-row">
      <div class="ap-stat-mini">
        <div class="ap-stat-mini-header">
          <span class="ap-stat-mini-label">Média de Pontuação</span>
          <span class="ap-stat-mini-icon ap-stat-icon-blue">
            <i class="ri-bar-chart-fill"></i>
          </span>
        </div>
        <div class="ap-stat-mini-value">26.4</div>
        <div class="ap-stat-mini-unit">PPG</div>
        <div class="ap-stat-mini-change ap-change-up">
          <i class="ri-arrow-up-line"></i> +1.2 vs temporada anterior
        </div>
      </div>

      <div class="ap-stat-mini">
        <div class="ap-stat-mini-header">
          <span class="ap-stat-mini-label">Média de Rebotes</span>
          <span class="ap-stat-mini-icon ap-stat-icon-green">
            <i class="ri-basketball-line"></i>
          </span>
        </div>
        <div class="ap-stat-mini-value">8.1</div>
        <div class="ap-stat-mini-unit">RPG</div>
        <div class="ap-stat-mini-change ap-change-down">
          <i class="ri-arrow-down-line"></i> -0.3 vs temporada anterior
        </div>
      </div>

      <div class="ap-stat-mini">
        <div class="ap-stat-mini-header">
          <span class="ap-stat-mini-label">Média de Assistências</span>
          <span class="ap-stat-mini-icon ap-stat-icon-purple">
            <i class="ri-hand-heart-line"></i>
          </span>
        </div>
        <div class="ap-stat-mini-value">6.7</div>
        <div class="ap-stat-mini-unit">APG</div>
        <div class="ap-stat-mini-change ap-change-up">
          <i class="ri-arrow-up-line"></i> +0.5 vs temporada anterior
        </div>
      </div>

      <div class="ap-stat-mini">
        <div class="ap-stat-mini-header">
          <span class="ap-stat-mini-label">Taxa de 3 Pontos</span>
          <span class="ap-stat-mini-icon ap-stat-icon-orange">
            <i class="ri-percent-line"></i>
          </span>
        </div>
        <div class="ap-stat-mini-value">37.8%</div>
        <div class="ap-stat-mini-unit">3P%</div>
        <div class="ap-stat-mini-change ap-change-up">
          <i class="ri-arrow-up-line"></i> +1.4% vs temporada anterior
        </div>
      </div>
    </div>

    <!-- ====================================================================
         [MAIN LAYOUT] Charts + Data Grid
         ==================================================================== -->
    <div class="ap-stats-layout">
      
      <!-- Charts Column -->
      <div class="ap-charts-column">
        <!-- Chart: Position Distribution -->
        <div class="ap-chart-card">
          <div class="ap-chart-header">
            <h3 class="ap-chart-title">Distribuição por Posição</h3>
          </div>
          <div class="ap-chart-wrapper">
            <canvas id="positionChart"></canvas>
          </div>
        </div>

        <!-- Chart: Top Trends -->
        <div class="ap-chart-card">
          <div class="ap-chart-header">
            <h3 class="ap-chart-title">Top 5 em Ascensão</h3>
          </div>
          <div class="ap-chart-wrapper">
            <canvas id="trendsChart"></canvas>
          </div>
        </div>

        <!-- Chart: Team Distribution -->
        <div class="ap-chart-card">
          <div class="ap-chart-header">
            <h3 class="ap-chart-title">Distribuição por Equipe</h3>
          </div>
          <div class="ap-chart-wrapper">
            <canvas id="teamsChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Grid Column -->
      <div class="ap-grid-column">
        <!-- Filter Section -->
        <div class="ap-grid-filters">
          <div class="ap-filter-tabs">
            <button class="ap-tab-pill active" data-filter="all" data-ap-tooltip="Mostrar todos">
              Todos
            </button>
            <button class="ap-tab-pill" data-filter="guards" data-ap-tooltip="Armadores e Ala-armadores">
              Guards
            </button>
            <button class="ap-tab-pill" data-filter="forwards" data-ap-tooltip="Alas e Ala-pivôs">
              Forwards
            </button>
            <button class="ap-tab-pill" data-filter="centers" data-ap-tooltip="Pivôs">
              Centers
            </button>
            <button class="ap-tab-pill" data-filter="rising" data-ap-tooltip="Em ascensão">
              <i class="ri-arrow-up-line"></i> Rising
            </button>
          </div>
          <div class="ap-search-form ap-search-sm">
            <i class="ri-search-line"></i>
            <input type="text" id="gridSearch" class="ap-search-input" placeholder="Buscar jogador...">
          </div>
        </div>

        <!-- Data Grid -->
        <div class="ap-data-grid">
          <div id="dataGrid" class="ap-ag-theme ag-theme-quartz"></div>
        </div>
      </div>
    </div>

  </div>

  <!-- ====================================================================
       [SCRIPTS] Statistics Dashboard JavaScript
       ==================================================================== -->
  <script>
  /**
   * APOLLO STATISTICS - JavaScript Controller
   * Handles AG Grid, Chart.js, filtering, and data management
   */
  (function() {
    'use strict';

    // Apollo Chart Color Palette
    const APOLLO_COLORS = {
      primary: '#f97316',
      secondary: '#3b82f6',
      success: '#22c55e',
      warning: '#eab308',
      danger: '#ef4444',
      purple: '#a855f7',
      pink: '#ec4899',
      teal: '#14b8a6',
      indigo: '#6366f1',
      slate: '#64748b',
      chart: [
        'rgba(249, 115, 22, 0.85)',  // Orange
        'rgba(59, 130, 246, 0.85)',  // Blue
        'rgba(34, 197, 94, 0.85)',   // Green
        'rgba(168, 85, 247, 0.85)',  // Purple
        'rgba(236, 72, 153, 0.85)',  // Pink
        'rgba(20, 184, 166, 0.85)',  // Teal
        'rgba(99, 102, 241, 0.85)',  // Indigo
        'rgba(234, 179, 8, 0.85)',   // Yellow
        'rgba(239, 68, 68, 0.85)',   // Red
        'rgba(100, 116, 139, 0.85)'  // Slate
      ]
    };

    // ========================================
    // DATA GENERATION
    // @PHP: Replace with actual WP_Query data
    // ========================================
    function generateSampleData(count) {
      const teams = [
        { code: 'LAL', name: 'Los Angeles Lakers' },
        { code: 'BOS', name: 'Boston Celtics' },
        { code: 'GSW', name: 'Golden State Warriors' },
        { code: 'MIA', name: 'Miami Heat' },
        { code: 'CHI', name: 'Chicago Bulls' },
        { code: 'PHI', name: 'Philadelphia 76ers' },
        { code: 'NYK', name: 'New York Knicks' },
        { code: 'DAL', name: 'Dallas Mavericks' },
        { code: 'MIL', name: 'Milwaukee Bucks' },
        { code: 'DEN', name: 'Denver Nuggets' }
      ];

      const positions = [
        { code: 'PG', name: 'Point Guard' },
        { code: 'SG', name: 'Shooting Guard' },
        { code: 'SF', name: 'Small Forward' },
        { code: 'PF', name: 'Power Forward' },
        { code: 'C', name: 'Center' }
      ];

      const players = [
        { firstName: 'LeBron', lastName: 'James' },
        { firstName: 'Kevin', lastName: 'Durant' },
        { firstName: 'Stephen', lastName: 'Curry' },
        { firstName: 'Giannis', lastName: 'Antetokounmpo' },
        { firstName: 'Luka', lastName: 'Doncic' },
        { firstName: 'Joel', lastName: 'Embiid' },
        { firstName: 'Nikola', lastName: 'Jokic' },
        { firstName: 'Jayson', lastName: 'Tatum' },
        { firstName: 'Ja', lastName: 'Morant' },
        { firstName: 'Anthony', lastName: 'Davis' },
        { firstName: 'Devin', lastName: 'Booker' },
        { firstName: 'Jimmy', lastName: 'Butler' },
        { firstName: 'Damian', lastName: 'Lillard' },
        { firstName: 'Kyrie', lastName: 'Irving' },
        { firstName: 'Kawhi', lastName: 'Leonard' }
      ];

      const trends = ['up', 'down', 'stable'];
      const result = [];

      for (let i = 0; i < count; i++) {
        const player = players[Math.floor(Math.random() * players.length)];
        const team = teams[Math.floor(Math.random() * teams.length)];
        const position = positions[Math.floor(Math.random() * positions.length)];
        const trend = trends[Math.floor(Math.random() * trends.length)];

        result.push({
          rank: i + 1,
          player: `${player.firstName} ${player.lastName}`,
          team: team.code,
          teamName: team.name,
          position: position.code,
          positionName: position.name,
          ppg: parseFloat((Math.random() * 20 + 10).toFixed(1)),
          rpg: parseFloat((Math.random() * 10 + 1).toFixed(1)),
          apg: parseFloat((Math.random() * 8 + 1).toFixed(1)),
          spg: parseFloat((Math.random() * 2 + 0.2).toFixed(1)),
          bpg: parseFloat((Math.random() * 2 + 0.1).toFixed(1)),
          fgPercentage: parseFloat((Math.random() * 20 + 40).toFixed(1)),
          threePointPercentage: parseFloat((Math.random() * 15 + 25).toFixed(1)),
          change: parseFloat((Math.random() * 4 - 2).toFixed(1)),
          trend
        });
      }

      return result;
    }

    // ========================================
    // AG GRID SETUP
    // ========================================
    function setupGrid(rowData) {
      const originalData = [...rowData];
      let gridApi = null;

      const columnDefs = [
        { 
          field: 'rank', 
          headerName: '#', 
          width: 60, 
          sort: 'asc',
          cellClass: 'ap-cell-rank'
        },
        { 
          field: 'player', 
          headerName: 'Jogador', 
          width: 180, 
          filter: true,
          cellClass: 'ap-cell-player'
        },
        { 
          field: 'team', 
          headerName: 'Time', 
          width: 90, 
          filter: true,
          cellRenderer: (params) => {
            return `<span class="ap-team-badge">${params.value}</span>`;
          }
        },
        { 
          field: 'position', 
          headerName: 'Pos', 
          width: 70, 
          filter: true 
        },
        { 
          field: 'ppg', 
          headerName: 'PPG', 
          width: 80,
          cellClass: 'ap-cell-stat'
        },
        { 
          field: 'rpg', 
          headerName: 'RPG', 
          width: 80,
          cellClass: 'ap-cell-stat'
        },
        { 
          field: 'apg', 
          headerName: 'APG', 
          width: 80,
          cellClass: 'ap-cell-stat'
        },
        { 
          field: 'fgPercentage', 
          headerName: 'FG%', 
          width: 80,
          cellClass: 'ap-cell-stat',
          valueFormatter: (params) => `${params.value}%`
        },
        { 
          field: 'threePointPercentage', 
          headerName: '3P%', 
          width: 80,
          cellClass: 'ap-cell-stat',
          valueFormatter: (params) => `${params.value}%`
        },
        {
          field: 'trend',
          headerName: 'Trend',
          width: 100,
          cellRenderer: (params) => {
            const badges = {
              up: '<span class="ap-badge-trend ap-badge-rising"><i class="ri-arrow-up-line"></i> Rising</span>',
              down: '<span class="ap-badge-trend ap-badge-falling"><i class="ri-arrow-down-line"></i> Falling</span>',
              stable: '<span class="ap-badge-trend ap-badge-stable"><i class="ri-subtract-line"></i> Stable</span>'
            };
            return badges[params.value] || '';
          }
        }
      ];

      const gridOptions = {
        columnDefs,
        rowData,
        defaultColDef: {
          resizable: true,
          sortable: true,
          suppressMovable: true
        },
        domLayout: 'autoHeight',
        pagination: true,
        paginationPageSize: 15,
        paginationPageSizeSelector: [10, 15, 25, 50],
        rowSelection: 'single',
        animateRows: true,
        onGridReady: (params) => {
          gridApi = params.api;
          params.api.sizeColumnsToFit();
        }
      };

      const gridDiv = document.getElementById('dataGrid');
      new agGrid.Grid(gridDiv, gridOptions);

      // Search functionality
      document.getElementById('gridSearch')?.addEventListener('input', (e) => {
        gridOptions.api?.setQuickFilter(e.target.value);
      });

      // Filter tabs
      document.querySelectorAll('.ap-tab-pill').forEach(btn => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.ap-tab-pill').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');

          const filterType = btn.dataset.filter;
          let filteredData = [...originalData];

          if (filterType === 'guards') {
            filteredData = filteredData.filter(p => ['PG', 'SG'].includes(p.position));
          } else if (filterType === 'forwards') {
            filteredData = filteredData.filter(p => ['SF', 'PF'].includes(p.position));
          } else if (filterType === 'centers') {
            filteredData = filteredData.filter(p => p.position === 'C');
          } else if (filterType === 'rising') {
            filteredData = filteredData.filter(p => p.trend === 'up');
          }

          gridOptions.api?.setRowData(filteredData);
          updateCharts(filteredData);
        });
      });

      // Window resize
      window.addEventListener('resize', () => {
        setTimeout(() => gridOptions.api?.sizeColumnsToFit(), 100);
      });

      return gridOptions;
    }

    // ========================================
    // CHART.JS SETUP
    // ========================================
    let charts = {};

    function setupCharts(data) {
      // Chart.js defaults for Apollo theme
      Chart.defaults.font.family = "'Inter', system-ui, sans-serif";
      Chart.defaults.font.size = 11;
      Chart.defaults.color = '#64748b';
      Chart.defaults.plugins.legend.labels.boxWidth = 12;
      Chart.defaults.plugins.legend.labels.padding = 8;

      // Position Distribution (Pie)
      const positionCounts = data.reduce((acc, p) => {
        acc[p.positionName] = (acc[p.positionName] || 0) + 1;
        return acc;
      }, {});

      charts.position = new Chart(document.getElementById('positionChart'), {
        type: 'pie',
        data: {
          labels: Object.keys(positionCounts),
          datasets: [{
            data: Object.values(positionCounts),
            backgroundColor: APOLLO_COLORS.chart,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'right' },
            tooltip: {
              callbacks: {
                label: (ctx) => {
                  const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                  const pct = Math.round((ctx.raw / total) * 100);
                  return `${ctx.label}: ${ctx.raw} (${pct}%)`;
                }
              }
            }
          }
        }
      });

      // Top Trends (Horizontal Bar)
      const topRising = [...data]
        .filter(p => p.trend === 'up')
        .sort((a, b) => b.ppg - a.ppg)
        .slice(0, 5);

      charts.trends = new Chart(document.getElementById('trendsChart'), {
        type: 'bar',
        data: {
          labels: topRising.map(p => p.player.split(' ').pop()),
          datasets: [{
            label: 'PPG',
            data: topRising.map(p => p.ppg),
            backgroundColor: APOLLO_COLORS.primary,
            borderRadius: 4
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                title: (ctx) => topRising[ctx[0].dataIndex]?.player || ''
              }
            }
          },
          scales: {
            x: { 
              beginAtZero: true,
              grid: { color: 'rgba(0,0,0,0.05)' }
            },
            y: { 
              grid: { display: false }
            }
          }
        }
      });

      // Team Distribution (Doughnut)
      const teamCounts = data.reduce((acc, p) => {
        acc[p.team] = (acc[p.team] || 0) + 1;
        return acc;
      }, {});

      charts.teams = new Chart(document.getElementById('teamsChart'), {
        type: 'doughnut',
        data: {
          labels: Object.keys(teamCounts),
          datasets: [{
            data: Object.values(teamCounts),
            backgroundColor: APOLLO_COLORS.chart,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '60%',
          plugins: {
            legend: {
              position: 'right',
              labels: { boxWidth: 10, font: { size: 10 } }
            }
          }
        }
      });
    }

    function updateCharts(filteredData) {
      // Update Position Chart
      const positionCounts = filteredData.reduce((acc, p) => {
        acc[p.positionName] = (acc[p.positionName] || 0) + 1;
        return acc;
      }, {});
      charts.position.data.labels = Object.keys(positionCounts);
      charts.position.data.datasets[0].data = Object.values(positionCounts);
      charts.position.update();

      // Update Trends Chart
      const topRising = [...filteredData]
        .filter(p => p.trend === 'up')
        .sort((a, b) => b.ppg - a.ppg)
        .slice(0, 5);
      charts.trends.data.labels = topRising.map(p => p.player.split(' ').pop());
      charts.trends.data.datasets[0].data = topRising.map(p => p.ppg);
      charts.trends.update();

      // Update Teams Chart
      const teamCounts = filteredData.reduce((acc, p) => {
        acc[p.team] = (acc[p.team] || 0) + 1;
        return acc;
      }, {});
      charts.teams.data.labels = Object.keys(teamCounts);
      charts.teams.data.datasets[0].data = Object.values(teamCounts);
      charts.teams.update();
    }

    // ========================================
    // INITIALIZATION
    // ========================================
    document.addEventListener('DOMContentLoaded', () => {
      // @PHP: Replace with wp_localize_script data
      const data = generateSampleData(100);
      
      setupGrid(data);
      setupCharts(data);

      // Animate stat values on load
      if (window.apolloDashboard) {
        apolloDashboard.animateStats(document);
      }

      console.log('[Apollo Statistics] Dashboard initialized');
    });

  })();
  </script>
</body>
</html>

