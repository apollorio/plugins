<!--
  Component: block-map-osm-M0
  Type: M0 (First design variant)
  Description: OpenStreetMap block with event markers
  Used in: Cena Rio calendar, Discover events, Local single page
  
  IMPORTANT: All elements MUST have data-tooltip for accessibility and UX
  NOTE: Coordinates auto-geocoded from local CPT address via Nominatim API
  
  Placeholders:
  - {{map_id}} - Unique ID for the map container
  - {{center_lat}} - Center latitude (default: -22.9068, Rio de Janeiro)
  - {{center_lng}} - Center longitude (default: -43.1729, Rio de Janeiro)
  - {{zoom}} - Initial zoom level (default: 12)
  - {{events_json}} - JSON array of events with lat/lng
  
  Each event in events_json should have:
  - id, title, lat, lng, date, venue, image_url, permalink, status
  
  Status colors:
  - published: #3b82f6 (blue)
  - confirmed: #10b981 (green)
  - expected: #f97316 (orange)
-->

<div class="block-map-osm" data-component="block-map-osm" data-type="M0">
  
  <!-- Map Container -->
  <div 
    id="{{map_id}}" 
    class="map-container w-full h-[400px] md:h-[500px] rounded-2xl overflow-hidden border border-slate-200 shadow-lg"
    data-center-lat="{{center_lat}}"
    data-center-lng="{{center_lng}}"
    data-zoom="{{zoom}}"
    data-tooltip="Mapa de eventos"
  ></div>
  
  <!-- Map Controls -->
  <div class="map-controls flex items-center justify-between mt-3 px-2">
    <div class="flex items-center gap-2">
      <button class="map-control-btn" data-action="zoom-in" data-tooltip="Aumentar zoom">
        <i class="ri-add-line"></i>
      </button>
      <button class="map-control-btn" data-action="zoom-out" data-tooltip="Diminuir zoom">
        <i class="ri-subtract-line"></i>
      </button>
      <button class="map-control-btn" data-action="locate-me" data-tooltip="Minha localização">
        <i class="ri-focus-3-line"></i>
      </button>
    </div>
    
    <div class="map-legend flex items-center gap-3 text-[11px] text-slate-500">
      <span class="flex items-center gap-1">
        <span class="h-3 w-3 rounded-full bg-orange-500"></span>
        Confirmado
      </span>
      <span class="flex items-center gap-1">
        <span class="h-3 w-3 rounded-full bg-blue-500"></span>
        Previsto
      </span>
    </div>
  </div>
  
</div>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<style>
.block-map-osm {
  position: relative;
}

.map-container {
  z-index: 1;
}

.map-control-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
  border-radius: 8px;
  background: white;
  border: 1px solid #e5e7eb;
  color: #64748b;
  cursor: pointer;
  transition: all 0.2s ease;
}

.map-control-btn:hover {
  background: #f8fafc;
  color: #0f172a;
  border-color: #cbd5e1;
}

/* Custom Marker */
.apollo-map-marker {
  background: linear-gradient(135deg, #f97316, #ea580c);
  border: 3px solid white;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  box-shadow: 0 4px 12px rgba(249, 115, 22, 0.4);
  cursor: pointer;
  transition: transform 0.2s ease;
}

.apollo-map-marker:hover {
  transform: scale(1.2);
}

.apollo-map-marker.predicted {
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
}

/* Popup Styles */
.apollo-map-popup .leaflet-popup-content-wrapper {
  background: white;
  border-radius: 12px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.15);
  padding: 0;
  overflow: hidden;
}

.apollo-map-popup .leaflet-popup-content {
  margin: 0;
  min-width: 200px;
}

.apollo-map-popup .leaflet-popup-tip {
  background: white;
}

.map-popup-content {
  padding: 12px;
}

.map-popup-content img {
  width: 100%;
  height: 100px;
  object-fit: cover;
  border-radius: 8px;
  margin-bottom: 8px;
}

.map-popup-content h4 {
  font-size: 14px;
  font-weight: 600;
  color: #0f172a;
  margin: 0 0 4px 0;
}

.map-popup-content p {
  font-size: 11px;
  color: #64748b;
  margin: 0;
}

.map-popup-content a {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  margin-top: 8px;
  font-size: 11px;
  font-weight: 600;
  color: #f97316;
  text-decoration: none;
}

.map-popup-content a:hover {
  text-decoration: underline;
}
</style>

<script>
(function() {
  const mapContainer = document.getElementById('{{map_id}}');
  if (!mapContainer || typeof L === 'undefined') return;
  
  const centerLat = parseFloat(mapContainer.dataset.centerLat) || -22.9068;
  const centerLng = parseFloat(mapContainer.dataset.centerLng) || -43.1729;
  const zoom = parseInt(mapContainer.dataset.zoom) || 12;
  
  // Initialize map
  const map = L.map('{{map_id}}').setView([centerLat, centerLng], zoom);
  
  // Add OpenStreetMap tiles
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; OpenStreetMap contributors'
  }).addTo(map);
  
  // Custom marker icon
  function createMarkerIcon(confirmed = true) {
    return L.divIcon({
      className: 'apollo-map-marker' + (confirmed ? '' : ' predicted'),
      iconSize: [24, 24],
      iconAnchor: [12, 12],
      popupAnchor: [0, -12]
    });
  }
  
  // Events data (will be replaced with actual data)
  const events = {{events_json}};
  
  // Add markers
  events.forEach(event => {
    if (!event.lat || !event.lng) return;
    
    const marker = L.marker([event.lat, event.lng], {
      icon: createMarkerIcon(event.confirmed !== false)
    }).addTo(map);
    
    const popupContent = `
      <div class="map-popup-content">
        ${event.image_url ? `<img src="${event.image_url}" alt="${event.title}">` : ''}
        <h4>${event.title}</h4>
        <p><i class="ri-calendar-line"></i> ${event.date}</p>
        <p><i class="ri-map-pin-line"></i> ${event.venue || 'Local a confirmar'}</p>
        <a href="${event.permalink}">Ver evento <i class="ri-arrow-right-line"></i></a>
      </div>
    `;
    
    marker.bindPopup(popupContent, {
      className: 'apollo-map-popup',
      maxWidth: 280
    });
  });
  
  // Map controls
  document.querySelector('[data-action="zoom-in"]')?.addEventListener('click', () => map.zoomIn());
  document.querySelector('[data-action="zoom-out"]')?.addEventListener('click', () => map.zoomOut());
  document.querySelector('[data-action="locate-me"]')?.addEventListener('click', () => {
    map.locate({ setView: true, maxZoom: 14 });
  });
})();
</script>

