name: PHP CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  php-lint:
    name: PHP Lint & Code Quality
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        php-version: ['8.1', '8.2', '8.3']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: mbstring, xml, zip, curl, gd, intl, mysqli, pdo, pdo_mysql
          coverage: none
      
      - name: Validate PHP syntax
        run: |
          find . -type f -name "*.php" -not -path "./node_modules/*" -not -path "./vendor/*" -not -path "./trx_addons/*" -exec php -l {} \;
      
      - name: Check WordPress Coding Standards
        run: |
          composer global require wp-coding-standards/wpcs --no-interaction --prefer-dist
          export PATH="$HOME/.composer/vendor/bin:$PATH"
          phpcs --version || echo "PHPCS not available, skipping..."
      
      - name: Security Check
        run: |
          composer global require phpstan/phpstan --no-interaction --prefer-dist || echo "PHPStan not available, skipping..."
          export PATH="$HOME/.composer/vendor/bin:$PATH"
          phpstan --version || echo "PHPStan check skipped"

  plugin-validation:
    name: Plugin Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: mbstring, xml, zip, curl, gd, intl, mysqli, pdo, pdo_mysql
      
      - name: Validate Apollo Social Plugin
        run: |
          if [ -f "apollo-social/apollo-social.php" ]; then
            php -l apollo-social/apollo-social.php
            echo "✅ apollo-social plugin file valid"
          fi
      
      - name: Validate Apollo Events Manager Plugin
        run: |
          if [ -f "apollo-events-manager/apollo-events-manager.php" ]; then
            php -l apollo-events-manager/apollo-events-manager.php
            echo "✅ apollo-events-manager plugin file valid"
          fi
      
      - name: Validate Apollo Rio Plugin
        run: |
          if [ -f "apollo-rio/apollo-rio.php" ]; then
            php -l apollo-rio/apollo-rio.php
            echo "✅ apollo-rio plugin file valid"
          fi
      
      - name: Check for critical files
        run: |
          echo "Checking critical plugin files..."
          [ -f "apollo-social/src/Plugin.php" ] && echo "✅ apollo-social/src/Plugin.php exists" || echo "⚠️ apollo-social/src/Plugin.php missing"
          [ -f "apollo-social/config/routes.php" ] && echo "✅ apollo-social/config/routes.php exists" || echo "⚠️ apollo-social/config/routes.php missing"
          [ -f "apollo-social/src/Infrastructure/Rendering/CanvasBuilder.php" ] && echo "✅ CanvasBuilder.php exists" || echo "⚠️ CanvasBuilder.php missing"
          [ -f "apollo-social/src/Core/PWADetector.php" ] && echo "✅ PWADetector.php exists" || echo "⚠️ PWADetector.php missing"
          [ -f "apollo-social/src/Core/RoleManager.php" ] && echo "✅ RoleManager.php exists" || echo "⚠️ RoleManager.php missing"

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run PHP Security Checker
        uses: symfonycorp/security-checker-action@v4
        with:
          format: 'json'
          lockfile: 'composer.lock'
        continue-on-error: true
      
      - name: Check for common security issues
        run: |
          echo "Checking for common security patterns..."
          # Check for direct $_POST/$_GET usage without sanitization
          if grep -r "\\\$_POST\[" --include="*.php" . | grep -v "sanitize\|wp_unslash\|absint\|esc_" | head -5; then
            echo "⚠️ Found potential unsanitized \$_POST usage"
          else
            echo "✅ No obvious unsanitized \$_POST found"
          fi
          
          # Check for direct $_GET usage without sanitization
          if grep -r "\\\$_GET\[" --include="*.php" . | grep -v "sanitize\|wp_unslash\|absint\|esc_" | head -5; then
            echo "⚠️ Found potential unsanitized \$_GET usage"
          else
            echo "✅ No obvious unsanitized \$_GET found"
          fi
          
          # Check for eval() usage
          if grep -r "eval(" --include="*.php" .; then
            echo "⚠️ Found eval() usage - review needed"
          else
            echo "✅ No eval() found"
          fi

  deploy-check:
    name: Deploy Readiness Check
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check deploy scripts
        run: |
          echo "Checking deploy scripts..."
          [ -f "apollo-social/create-production-zip.ps1" ] && echo "✅ apollo-social deploy script exists" || echo "❌ apollo-social deploy script missing"
          [ -f "apollo-events-manager/create-production-zip.ps1" ] && echo "✅ apollo-events-manager deploy script exists" || echo "❌ apollo-events-manager deploy script missing"
          [ -f "apollo-rio/create-production-zip.ps1" ] && echo "✅ apollo-rio deploy script exists" || echo "❌ apollo-rio deploy script missing"
          [ -f "create-all-plugins-zip.ps1" ] && echo "✅ Master deploy script exists" || echo "❌ Master deploy script missing"
      
      - name: Check documentation
        run: |
          echo "Checking documentation files..."
          [ -f "DEPLOY-FINAL-CHECKLIST.md" ] && echo "✅ DEPLOY-FINAL-CHECKLIST.md exists" || echo "⚠️ DEPLOY-FINAL-CHECKLIST.md missing"
          [ -f "DEPLOY-STATUS-FINAL.md" ] && echo "✅ DEPLOY-STATUS-FINAL.md exists" || echo "⚠️ DEPLOY-STATUS-FINAL.md missing"

